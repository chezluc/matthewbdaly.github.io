<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><link href="http://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet" type="text/css"><link rel="stylesheet" type="text/css" href="/static/bower_components/sass-bootstrap/dist/css/bootstrap.min.css" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><title>Django Blog Tutorial - the Next Generation - Part 3 - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="http://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input id="search" type="search" name="q" placeholder="Search..." maxlength="200" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">3rd January 2014 12:57 pm</p><h1>Django Blog Tutorial - the Next Generation - Part 3</h1><p>Hello again! In this instalment, we’re going to do the following:</p><ul><li>Add support for flat pages</li><li>Add support for multiple authors</li><li>Add a third-party comment system</li></ul><h2 id="flat-pages">Flat pages</h2><p>Django ships with a number of useful apps - we’ve already used the admin interface. The flat pages app is another very handy app that comes with Django, and we’ll use it to allow the blog author to create a handful of flat pages.</p><p>First of all, you’ll need to install the flatpages app. Edit the <code>INSTALLED_APPS</code> setting as follows:</p><pre><code class="hljs lang-python">INSTALLED_APPS = (
    <span class="hljs-string">'django.contrib.admin'</span>,
    <span class="hljs-string">'django.contrib.auth'</span>,
    <span class="hljs-string">'django.contrib.contenttypes'</span>,
    <span class="hljs-string">'django.contrib.sessions'</span>,
    <span class="hljs-string">'django.contrib.messages'</span>,
    <span class="hljs-string">'django.contrib.staticfiles'</span>,
    <span class="hljs-string">'south'</span>,
    <span class="hljs-string">'blogengine'</span>,
    <span class="hljs-string">'django.contrib.sites'</span>,
    <span class="hljs-string">'django.contrib.flatpages'</span>,
)
</code></pre><p>Note that we needed to enable the <code>sites</code> framework as well. You’ll also need to set the <code>SITE_ID</code> setting:</p><pre><code class="hljs lang-python">SITE_ID = <span class="hljs-number">1</span>
</code></pre><p>With that done, run <code>python manage.py syncdb</code> to create the required database tables. Now, let’s use the <code>sqlall</code> command to take a look at the database structure generated for the flat pages:</p><pre><code class="hljs lang-sql"><span class="hljs-operator"><span class="hljs-keyword">BEGIN</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"django_flatpage_sites"</span> (
    <span class="hljs-string">"id"</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span>,
    <span class="hljs-string">"flatpage_id"</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-string">"site_id"</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">REFERENCES</span> <span class="hljs-string">"django_site"</span> (<span class="hljs-string">"id"</span>),
    <span class="hljs-keyword">UNIQUE</span> (<span class="hljs-string">"flatpage_id"</span>, <span class="hljs-string">"site_id"</span>)
)
;</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"django_flatpage"</span> (
    <span class="hljs-string">"id"</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span>,
    <span class="hljs-string">"url"</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-string">"title"</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-string">"content"</span> <span class="hljs-built_in">text</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-string">"enable_comments"</span> bool <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-string">"template_name"</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">70</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-string">"registration_required"</span> bool <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
)
;</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-string">"django_flatpage_sites_872c4601"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"django_flatpage_sites"</span> (<span class="hljs-string">"flatpage_id"</span>);</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-string">"django_flatpage_sites_99732b5c"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"django_flatpage_sites"</span> (<span class="hljs-string">"site_id"</span>);</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-string">"django_flatpage_c379dc61"</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">"django_flatpage"</span> (<span class="hljs-string">"url"</span>);</span>

<span class="hljs-operator"><span class="hljs-keyword">COMMIT</span>;</span>
</code></pre><p>As mentioned previously, all models in Django have an <code>id</code> attribute by default. Each flat page also has a URL, title, and content.</p><p>Also note the separate <code>django_flatpage_sites</code> table, which maps sites to flat pages. Django can run multiple sites from the same web app, and so flat pages must be allocated to a specific site. This relationship is a many-to-many relationship, so one flat page can appear on more than one site.</p><p>The other fields <a href="http://127.0.0.1:8000/admin/flatpages/flatpage/add/">are hidden by default in the admin</a> and can be ignored. Let’s have a go with Django’s handy shell to explore the flatpage. Run <code>python manage.py shell</code> and you’ll be able to interact with your Django application interactively:</p><pre><code class="hljs lang-python">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py shell
Python 2.7.6 (default, Nov 23 2013, 13:53:45)
[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)
&gt;&gt;&gt; from django.contrib.flatpages.models import *
&gt;&gt;&gt; FlatPage
&lt;class 'django.contrib.flatpages.models.FlatPage'&gt;
&gt;&gt;&gt; from django.contrib.sites.models import Site
&gt;&gt;&gt; Site.objects.all()
[&lt;Site: example.com&gt;]
</code></pre><p>As you can see, <code>flatpages</code> is a Django app similar to the <code>blogengine</code> one, with its own models, as is <code>sites</code>. You can see that the <code>FlatPage</code> class is a model. We can create an instance of it and save it interactively:</p><pre><code class="hljs lang-python"><span class="hljs-prompt">&gt;&gt;&gt; </span>f = FlatPage()
<span class="hljs-prompt">&gt;&gt;&gt; </span>f.url = <span class="hljs-string">'/about/'</span>
<span class="hljs-prompt">&gt;&gt;&gt; </span>f.title = <span class="hljs-string">'About me'</span>
<span class="hljs-prompt">&gt;&gt;&gt; </span>f.content = <span class="hljs-string">'All about me'</span>
<span class="hljs-prompt">&gt;&gt;&gt; </span>f.save()
<span class="hljs-prompt">&gt;&gt;&gt; </span>f.sites.add(Site.objects.all()[<span class="hljs-number">0</span>])
<span class="hljs-prompt">&gt;&gt;&gt; </span>f.save()
</code></pre><p>Note that because the relationship between the site and the flat page is a many-to-many relationship, we need to save it first, then use the <code>add</code> method to add the site to the list of sites.</p><p>We can retrieve it:</p><pre><code class="hljs lang-python"><span class="hljs-prompt">&gt;&gt;&gt; </span>FlatPage.objects.all()
[&lt;FlatPage: /about/ -- About me&gt;]
<span class="hljs-prompt">&gt;&gt;&gt; </span>FlatPage.objects.all()[<span class="hljs-number">0</span>]
&lt;FlatPage: /about/ -- About me&gt;
<span class="hljs-prompt">&gt;&gt;&gt; </span>FlatPage.objects.all()[<span class="hljs-number">0</span>].title
<span class="hljs-string">u'About me'</span>
</code></pre><p>This command is often handy for debugging problems with your models interactively. If you now run the server and visit the admin, you should notice that the Flatpages app is now visible there, and the ‘About me’ flat page is now shown in there.</p><p>Let’s also take a look at the SQL required for the <code>Site</code> model. Run <code>python manage.py sqlall sites</code>:</p><pre><code class="hljs lang-sql"><span class="hljs-operator"><span class="hljs-keyword">BEGIN</span>;</span>
<span class="hljs-operator"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">"django_site"</span> (
    <span class="hljs-string">"id"</span> <span class="hljs-built_in">integer</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">PRIMARY</span> <span class="hljs-keyword">KEY</span>,
    <span class="hljs-string">"domain"</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>,
    <span class="hljs-string">"name"</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span>
)
;</span>

<span class="hljs-operator"><span class="hljs-keyword">COMMIT</span>;</span>
</code></pre><p>Again, very simple - just a domain and a name.</p><p>So, now that we have a good idea of how the flat page system works, we can write a test for it. We don’t need to write unit tests for the model because Django already does that, but we do need to write an acceptance test to ensure we can create flat pages and they will be where we expect them to be. Add the following to the top of the test file:</p><pre><code class="hljs lang-python"><span class="hljs-keyword">from</span> django.contrib.flatpages.models <span class="hljs-keyword">import</span> FlatPage
<span class="hljs-keyword">from</span> django.contrib.sites.models <span class="hljs-keyword">import</span> Site
</code></pre><p>Now, before we write this test, there’s some duplication to resolve. We have two tests that subclass <code>LiveServerTestCase</code>, and both have the same method, <code>setUp</code>. We can save ourselves some hassle by creating a new class containing this method and having both these tests inherit from it. We’ll do that now because the flat page test can also be based on it. Create the following class just after <code>PostTest</code>:</p><pre><code class="hljs lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseAcceptanceTest</span><span class="hljs-params">(LiveServerTestCase)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span><span class="hljs-params">(self)</span>:</span>
        self.client = Client()
</code></pre><p>Then remove the setUp method from each of the two tests based on <code>LiveServerTestCase</code>, and change their parent class to <code>BaseAcceptanceTest</code>:</p><pre><code class="hljs lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminTest</span><span class="hljs-params">(BaseAcceptanceTest)</span>:</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostViewTest</span><span class="hljs-params">(BaseAcceptanceTest)</span>:</span>
</code></pre><p>With that done, run the tests and they should pass. Commit your changes:</p><pre><code class="hljs lang-bash">$ git add blogengine/tests.py django_tutorial_blog_ng/settings.py
$ git commit -m <span class="hljs-string">'Added flatpages to installed apps'</span>
</code></pre><p>Now we can get started in earnest on our test for the flat pages:</p><pre><code class="hljs lang-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlatPageViewTest</span><span class="hljs-params">(BaseAcceptanceTest)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_flat_page</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create flat page</span>
        page = FlatPage()
        page.url = <span class="hljs-string">'/about/'</span>
        page.title = <span class="hljs-string">'About me'</span>
        page.content = <span class="hljs-string">'All about me'</span>
        page.save()

        <span class="hljs-comment"># Add the site</span>
        page.sites.add(Site.objects.all()[<span class="hljs-number">0</span>])
        page.save()

        <span class="hljs-comment"># Check new page saved</span>
        all_pages = FlatPage.objects.all()
        self.assertEquals(len(all_pages), <span class="hljs-number">1</span>)
        only_page = all_pages[<span class="hljs-number">0</span>]
        self.assertEquals(only_page, page)

        <span class="hljs-comment"># Check data correct</span>
        self.assertEquals(only_page.url, <span class="hljs-string">'/about/'</span>)
        self.assertEquals(only_page.title, <span class="hljs-string">'About me'</span>)
        self.assertEquals(only_page.content, <span class="hljs-string">'All about me'</span>)

        <span class="hljs-comment"># Get URL</span>
        page_url = only_page.get_absolute_url()

        <span class="hljs-comment"># Get the page</span>
        response = self.client.get(page_url)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check title and content in response</span>
        self.assertTrue(<span class="hljs-string">'About me'</span> <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(<span class="hljs-string">'All about me'</span> <span class="hljs-keyword">in</span> response.content)
</code></pre><p>Let’s run our tests:</p><pre><code class="hljs lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py <span class="hljs-built_in">test</span>
Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
......F..
======================================================================
FAIL: <span class="hljs-built_in">test</span>_create_flat_page (blogengine.tests.FlatPageViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line <span class="hljs-number">272</span>, <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span>_create_flat_page
    self.assertEquals(response.status_code, <span class="hljs-number">200</span>)
AssertionError: <span class="hljs-number">404</span> != <span class="hljs-number">200</span>

----------------------------------------------------------------------
Ran <span class="hljs-number">9</span> tests <span class="hljs-keyword">in</span> <span class="hljs-number">2.760</span>s

FAILED (failures=<span class="hljs-number">1</span>)
</code></pre><p>We can see why it’s failed - in our flat page test, the status code is 404, indicating the page was not found. This just means we haven’t put flat page support into our URLconf. So let’s fix that:</p><pre><code class="hljs lang-python"><span class="hljs-keyword">from</span> django.conf.urls <span class="hljs-keyword">import</span> patterns, include, url

<span class="hljs-keyword">from</span> django.contrib <span class="hljs-keyword">import</span> admin
admin.autodiscover()

urlpatterns = patterns(<span class="hljs-string">''</span>,
    <span class="hljs-comment"># Examples:</span>
    <span class="hljs-comment"># url(r'^$', 'django_tutorial_blog_ng.views.home', name='home'),</span>
    <span class="hljs-comment"># url(r'^blog/', include('blog.urls')),</span>

    url(<span class="hljs-string">r'^admin/'</span>, include(admin.site.urls)),

    <span class="hljs-comment"># Blog URLs</span>
    url(<span class="hljs-string">r''</span>, include(<span class="hljs-string">'blogengine.urls'</span>)),

    <span class="hljs-comment"># Flat pages</span>
    url(<span class="hljs-string">r''</span>, include(<span class="hljs-string">'django.contrib.flatpages.urls'</span>)),
)
</code></pre><p>Let’s run our tests again:</p><pre><code class="hljs lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py <span class="hljs-built_in">test</span>
Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
......E..
======================================================================
ERROR: <span class="hljs-built_in">test</span>_create_flat_page (blogengine.tests.FlatPageViewTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line <span class="hljs-number">276</span>, <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span>_create_flat_page
    response = self.client.get(page_url)
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/test/client.py"</span>, line <span class="hljs-number">473</span>, <span class="hljs-keyword">in</span> get
    response = super(Client, self).get(path, data=data, **extra)
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/test/client.py"</span>, line <span class="hljs-number">280</span>, <span class="hljs-keyword">in</span> get
    <span class="hljs-built_in">return</span> self.request(**r)
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/test/client.py"</span>, line <span class="hljs-number">444</span>, <span class="hljs-keyword">in</span> request
    six.reraise(*exc_info)
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/core/handlers/base.py"</span>, line <span class="hljs-number">114</span>, <span class="hljs-keyword">in</span> get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/contrib/flatpages/views.py"</span>, line <span class="hljs-number">45</span>, <span class="hljs-keyword">in</span> flatpage
    <span class="hljs-built_in">return</span> render_flatpage(request, f)
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/utils/decorators.py"</span>, line <span class="hljs-number">99</span>, <span class="hljs-keyword">in</span> _wrapped_view
    response = view_func(request, *args, **kwargs)
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/contrib/flatpages/views.py"</span>, line <span class="hljs-number">60</span>, <span class="hljs-keyword">in</span> render_flatpage
    t = loader.get_template(DEFAULT_TEMPLATE)
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/template/loader.py"</span>, line <span class="hljs-number">138</span>, <span class="hljs-keyword">in</span> get_template
    template, origin = find_template(template_name)
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/venv/lib/python2.7/site-packages/django/template/loader.py"</span>, line <span class="hljs-number">131</span>, <span class="hljs-keyword">in</span> find_template
    raise TemplateDoesNotExist(name)
TemplateDoesNotExist: flatpages/default.html

----------------------------------------------------------------------
Ran <span class="hljs-number">9</span> tests <span class="hljs-keyword">in</span> <span class="hljs-number">3.557</span>s

FAILED (errors=<span class="hljs-number">1</span>)
Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
</code></pre><p>Our test still fails, but we can easily see why - the template <code>flatpages/default.html</code> doesn’t exist. So we create it:</p><pre><code class="hljs lang-django"><span class="xml"></span><span class="hljs-template_tag">{% <span class="hljs-keyword">extends</span> "blogengine/includes/base.html" %}</span><span class="xml">

    </span><span class="hljs-template_tag">{% <span class="hljs-keyword">load</span> custom_markdown %}</span><span class="xml">

    </span><span class="hljs-template_tag">{% <span class="hljs-keyword">block</span> content %}</span><span class="xml">
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"post"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">h1</span>&gt;</span></span><span class="hljs-variable">{{ flatpage.title }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>
        </span><span class="hljs-variable">{{ flatpage.content<span class="hljs-filter">|custom</span>_markdown }}</span><span class="xml">
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>

    </span><span class="hljs-template_tag">{% <span class="hljs-keyword">endblock</span> %}</span><span class="xml"></span>
</code></pre><p>This template is based on the blog post one, and just changes a handful of variable names. Note that it can still inherit from the blogengine base template, and in this case we’re using that for the sake of consistency.</p><p>If you run your tests, you should now see that they pass, so we’ll commit our changes:</p><pre><code class="hljs lang-bash">$ git add templates/ django_tutorial_blog_ng/ blogengine/
$ git commit -m <span class="hljs-string">'Implemented flat page support'</span>
</code></pre><h2 id="multiple-authors">Multiple authors</h2><p>Next we’ll add support for multiple authors. Now, Django already has a User model, and we’ll leverage that to represent the authors. But first we’ll write our test:</p><pre><code class="hljs lang-python"><span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> TestCase, LiveServerTestCase, Client
<span class="hljs-keyword">from</span> django.utils <span class="hljs-keyword">import</span> timezone
<span class="hljs-keyword">from</span> blogengine.models <span class="hljs-keyword">import</span> Post
<span class="hljs-keyword">from</span> django.contrib.flatpages.models <span class="hljs-keyword">import</span> FlatPage
<span class="hljs-keyword">from</span> django.contrib.sites.models <span class="hljs-keyword">import</span> Site
<span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> User
<span class="hljs-keyword">import</span> markdown

<span class="hljs-comment"># Create your tests here.</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostTest</span><span class="hljs-params">(TestCase)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_post</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()

        <span class="hljs-comment"># Set the attributes</span>
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is my first blog post'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author

        <span class="hljs-comment"># Save it</span>
        post.save()

        <span class="hljs-comment"># Check we can find it</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)
        only_post = all_posts[<span class="hljs-number">0</span>]
        self.assertEquals(only_post, post)

        <span class="hljs-comment"># Check attributes</span>
        self.assertEquals(only_post.title, <span class="hljs-string">'My first post'</span>)
        self.assertEquals(only_post.text, <span class="hljs-string">'This is my first blog post'</span>)
        self.assertEquals(only_post.slug, <span class="hljs-string">'my-first-post'</span>)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
        self.assertEquals(only_post.author.username, <span class="hljs-string">'testuser'</span>)
        self.assertEquals(only_post.author.email, <span class="hljs-string">'user@example.com'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseAcceptanceTest</span><span class="hljs-params">(LiveServerTestCase)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span><span class="hljs-params">(self)</span>:</span>
        self.client = Client()


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminTest</span><span class="hljs-params">(BaseAcceptanceTest)</span>:</span>
    fixtures = [<span class="hljs-string">'users.json'</span>]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_login</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Get login page</span>
        response = self.client.get(<span class="hljs-string">'/admin/'</span>)

        <span class="hljs-comment"># Check response code</span>
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check 'Log in' in response</span>
        self.assertTrue(<span class="hljs-string">'Log in'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Log the user in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Check response code</span>
        response = self.client.get(<span class="hljs-string">'/admin/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check 'Log out' in response</span>
        self.assertTrue(<span class="hljs-string">'Log out'</span> <span class="hljs-keyword">in</span> response.content)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_logout</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Log in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Check response code</span>
        response = self.client.get(<span class="hljs-string">'/admin/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check 'Log out' in response</span>
        self.assertTrue(<span class="hljs-string">'Log out'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Log out</span>
        self.client.logout()

        <span class="hljs-comment"># Check response code</span>
        response = self.client.get(<span class="hljs-string">'/admin/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check 'Log in' in response</span>
        self.assertTrue(<span class="hljs-string">'Log in'</span> <span class="hljs-keyword">in</span> response.content)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_post</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Log in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Check response code</span>
        response = self.client.get(<span class="hljs-string">'/admin/blogengine/post/add/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Create the new post</span>
        response = self.client.post(<span class="hljs-string">'/admin/blogengine/post/add/'</span>, {
            <span class="hljs-string">'title'</span>: <span class="hljs-string">'My first post'</span>,
            <span class="hljs-string">'text'</span>: <span class="hljs-string">'This is my first post'</span>,
            <span class="hljs-string">'pub_date_0'</span>: <span class="hljs-string">'2013-12-28'</span>,
            <span class="hljs-string">'pub_date_1'</span>: <span class="hljs-string">'22:00:04'</span>,
            <span class="hljs-string">'slug'</span>: <span class="hljs-string">'my-first-post'</span>
        },
        follow=<span class="hljs-keyword">True</span>
        )
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check added successfully</span>
        self.assertTrue(<span class="hljs-string">'added successfully'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check new post now in database</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_edit_post</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is my first blog post'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        <span class="hljs-comment"># Log in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Edit the post</span>
        response = self.client.post(<span class="hljs-string">'/admin/blogengine/post/1/'</span>, {
            <span class="hljs-string">'title'</span>: <span class="hljs-string">'My second post'</span>,
            <span class="hljs-string">'text'</span>: <span class="hljs-string">'This is my second blog post'</span>,
            <span class="hljs-string">'pub_date_0'</span>: <span class="hljs-string">'2013-12-28'</span>,
            <span class="hljs-string">'pub_date_1'</span>: <span class="hljs-string">'22:00:04'</span>,
            <span class="hljs-string">'slug'</span>: <span class="hljs-string">'my-second-post'</span>
        },
        follow=<span class="hljs-keyword">True</span>
        )
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check changed successfully</span>
        self.assertTrue(<span class="hljs-string">'changed successfully'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check post amended</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)
        only_post = all_posts[<span class="hljs-number">0</span>]
        self.assertEquals(only_post.title, <span class="hljs-string">'My second post'</span>)
        self.assertEquals(only_post.text, <span class="hljs-string">'This is my second blog post'</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_delete_post</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is my first blog post'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        <span class="hljs-comment"># Check new post saved</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)

        <span class="hljs-comment"># Log in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Delete the post</span>
        response = self.client.post(<span class="hljs-string">'/admin/blogengine/post/1/delete/'</span>, {
            <span class="hljs-string">'post'</span>: <span class="hljs-string">'yes'</span>
        }, follow=<span class="hljs-keyword">True</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check deleted successfully</span>
        self.assertTrue(<span class="hljs-string">'deleted successfully'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check post amended</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">0</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostViewTest</span><span class="hljs-params">(BaseAcceptanceTest)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_index</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is [my first blog post](http://127.0.0.1:8000/)'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        <span class="hljs-comment"># Check new post saved</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)

        <span class="hljs-comment"># Fetch the index</span>
        response = self.client.get(<span class="hljs-string">'/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check the post title is in the response</span>
        self.assertTrue(post.title <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the post text is in the response</span>
        self.assertTrue(markdown.markdown(post.text) <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the post date is in the response</span>
        self.assertTrue(str(post.pub_date.year) <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(post.pub_date.strftime(<span class="hljs-string">'%b'</span>) <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(str(post.pub_date.day) <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the link is marked up properly</span>
        self.assertTrue(<span class="hljs-string">'&lt;a href="http://127.0.0.1:8000/"&gt;my first blog post&lt;/a&gt;'</span> <span class="hljs-keyword">in</span> response.content)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_post_page</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is [my first blog post](http://127.0.0.1:8000/)'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author
        post.save()

        <span class="hljs-comment"># Check new post saved</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)
        only_post = all_posts[<span class="hljs-number">0</span>]
        self.assertEquals(only_post, post)

        <span class="hljs-comment"># Get the post URL</span>
        post_url = only_post.get_absolute_url()

        <span class="hljs-comment"># Fetch the post</span>
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check the post title is in the response</span>
        self.assertTrue(post.title <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the post text is in the response</span>
        self.assertTrue(markdown.markdown(post.text) <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the post date is in the response</span>
        self.assertTrue(str(post.pub_date.year) <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(post.pub_date.strftime(<span class="hljs-string">'%b'</span>) <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(str(post.pub_date.day) <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the link is marked up properly</span>
        self.assertTrue(<span class="hljs-string">'&lt;a href="http://127.0.0.1:8000/"&gt;my first blog post&lt;/a&gt;'</span> <span class="hljs-keyword">in</span> response.content)


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlatPageViewTest</span><span class="hljs-params">(BaseAcceptanceTest)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_flat_page</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create flat page</span>
        page = FlatPage()
        page.url = <span class="hljs-string">'/about/'</span>
        page.title = <span class="hljs-string">'About me'</span>
        page.content = <span class="hljs-string">'All about me'</span>
        page.save()

        <span class="hljs-comment"># Add the site</span>
        page.sites.add(Site.objects.all()[<span class="hljs-number">0</span>])
        page.save()

        <span class="hljs-comment"># Check new page saved</span>
        all_pages = FlatPage.objects.all()
        self.assertEquals(len(all_pages), <span class="hljs-number">1</span>)
        only_page = all_pages[<span class="hljs-number">0</span>]
        self.assertEquals(only_page, page)

        <span class="hljs-comment"># Check data correct</span>
        self.assertEquals(only_page.url, <span class="hljs-string">'/about/'</span>)
        self.assertEquals(only_page.title, <span class="hljs-string">'About me'</span>)
        self.assertEquals(only_page.content, <span class="hljs-string">'All about me'</span>)

        <span class="hljs-comment"># Get URL</span>
        page_url = str(only_page.get_absolute_url())

        <span class="hljs-comment"># Get the page</span>
        response = self.client.get(page_url)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check title and content in response</span>
        self.assertTrue(<span class="hljs-string">'About me'</span> <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(<span class="hljs-string">'All about me'</span> <span class="hljs-keyword">in</span> response.content)
</code></pre><p>Here we create a <code>User</code> object to represent the author. Note the <code>create_user</code> convenience method for creating new users quickly and easily.</p><p>We’re going to exclude the author field from the admin - instead it’s going to be automatically populated based on the session data, so that when a user creates a post they are automatically set as the author. We therefore don’t need to make any changes for the acceptance tests for posts - our changes to the unit tests for the <code>Post</code> model are sufficient.</p><p>Run the tests, and they should fail:</p><pre><code class="hljs lang-python">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py test
Creating test database <span class="hljs-keyword">for</span> alias <span class="hljs-string">'default'</span>...
E........
======================================================================
ERROR: test_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line <span class="hljs-number">45</span>, <span class="hljs-keyword">in</span> test_create_post
    self.assertEquals(only_post.author.username, <span class="hljs-string">'testuser'</span>)
AttributeError: <span class="hljs-string">'Post'</span> object has no attribute <span class="hljs-string">'author'</span>

----------------------------------------------------------------------
Ran <span class="hljs-number">9</span> tests <span class="hljs-keyword">in</span> <span class="hljs-number">3.620</span>s

FAILED (errors=<span class="hljs-number">1</span>)
Destroying test database <span class="hljs-keyword">for</span> alias <span class="hljs-string">'default'</span>...
</code></pre><p>Let’s add the missing <code>author</code> attribute:</p><pre><code class="hljs lang-python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models
<span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> User

<span class="hljs-comment"># Create your models here.</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span><span class="hljs-params">(models.Model)</span>:</span>
    title = models.CharField(max_length=<span class="hljs-number">200</span>)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=<span class="hljs-number">40</span>, unique=<span class="hljs-keyword">True</span>)
    author = models.ForeignKey(User)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_absolute_url</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"/%s/%s/%s/"</span> % (self.pub_date.year, self.pub_date.month, self.slug)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__unicode__</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> self.title

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        ordering = [<span class="hljs-string">"-pub_date"</span>]
</code></pre><p>Next, create the migrations:</p><pre><code class="hljs lang-bash">$ python manage.py schemamigration --auto blogengine
</code></pre><p>You’ll be prompted to either quit or provide a default author ID - select option 2 to provide the ID, then enter 1, which should be your own user account ID. Then run the migrations:</p><pre><code class="hljs lang-bash">$ python manage.py migrate
</code></pre><p>Let’s run our tests again:</p><pre><code class="hljs lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py <span class="hljs-built_in">test</span>
Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
.F.F.....
======================================================================
FAIL: <span class="hljs-built_in">test</span>_create_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line <span class="hljs-number">118</span>, <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span>_create_post
    self.assertTrue(<span class="hljs-string">'added successfully'</span> <span class="hljs-keyword">in</span> response.content)
AssertionError: False is not <span class="hljs-literal">true</span>

======================================================================
FAIL: <span class="hljs-built_in">test</span>_edit_post (blogengine.tests.AdminTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line <span class="hljs-number">154</span>, <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span>_edit_post
    self.assertTrue(<span class="hljs-string">'changed successfully'</span> <span class="hljs-keyword">in</span> response.content)
AssertionError: False is not <span class="hljs-literal">true</span>

----------------------------------------------------------------------
Ran <span class="hljs-number">9</span> tests <span class="hljs-keyword">in</span> <span class="hljs-number">3.390</span>s

FAILED (failures=<span class="hljs-number">2</span>)
Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
</code></pre><p>Our test still fails because the author field isn’t set automatically. So we’ll amend the admin to automatically set the author when the <code>Post</code> object is saved:</p><pre><code class="hljs lang-python"><span class="hljs-keyword">import</span> models
<span class="hljs-keyword">from</span> django.contrib <span class="hljs-keyword">import</span> admin
<span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> User

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostAdmin</span><span class="hljs-params">(admin.ModelAdmin)</span>:</span>
    prepopulated_fields = {<span class="hljs-string">"slug"</span>: (<span class="hljs-string">"title"</span>,)}
    exclude = (<span class="hljs-string">'author'</span>,)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">save_model</span><span class="hljs-params">(self, request, obj, form, change)</span>:</span>
        obj.author = request.user
        obj.save()

admin.site.register(models.Post, PostAdmin)
</code></pre><p>This tells the admin to exclude the <code>author</code> field from any form for a post, and when the model is saved, to set the author to the user making the HTTP request. Now run the tests, and they should pass:</p><pre><code class="hljs lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py <span class="hljs-built_in">test</span>
Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
.........
----------------------------------------------------------------------
Ran <span class="hljs-number">9</span> tests <span class="hljs-keyword">in</span> <span class="hljs-number">4.086</span>s

OK
Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
</code></pre><p>Time to commit again:</p><pre><code class="hljs lang-bash">$ git add blogengine/
$ git commit -m <span class="hljs-string">'Added author field'</span>
</code></pre><h2 id="comments">Comments</h2><p>The <a href="http://matthewdaly.co.uk/blog/2012/03/29/yet-another-tutorial-for-building-a-blog-using-python-and-django-part-4/">previous version of this tutorial</a> implemented comments using Django’s own comment system. However, this has since been deprecated from Django and turned into <a href="https://github.com/django/django-contrib-comments">a separate project</a>. So we have two options for how to implement comments:</p><ul><li>We can use <a href="http://django-contrib-comments.readthedocs.org/en/latest/">the comments system</a></li><li>We can use a third-party comments system</li></ul><p>Now, if you want to use the Django comment system, you can do so, and it shouldn’t be too hard to puzzle out how to implement it using the documentation and my prior post. However, in my humble opinion, using a third-party comment system is the way to go for blog comments - they make it extremely easy for people to log in with multiple services without you having to write lots of additional code. They also make it significantly easier to moderate comments, and they’re generally pretty good at handling comment spam.</p><p>Some of the available providers include:</p><ul><li><a href="http://disqus.com/">Disqus</a></li><li><a href="http://intensedebate.com/">IntenseDebate</a></li><li><a href="https://developers.facebook.com/docs/plugins/comments/">Facebook</a></li></ul><p>For demonstration purposes, we’ll use Facebook comments, but this shouldn’t require much work to adapt it to the other providers.</p><p>First of all, we need to include the Facebook JavaScript SDK:</p><pre><code class="hljs lang-django"><span class="xml">        <span class="hljs-comment">&lt;!-- Add your site or application content here --&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"fb-root"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="clojure"><span class="hljs-list">(<span class="hljs-keyword">function</span><span class="hljs-list">(<span class="hljs-keyword">d</span>, s, id)</span> <span class="hljs-collection">{
            var js, fjs = d.getElementsByTagName<span class="hljs-list">(<span class="hljs-keyword">s</span>)</span><span class="hljs-collection">[<span class="hljs-number">0</span>]</span><span class="hljs-comment">;</span>
            if <span class="hljs-list">(<span class="hljs-keyword">d.getElementById</span><span class="hljs-list">(<span class="hljs-keyword">id</span>)</span>)</span> return;
                js = d.createElement<span class="hljs-list">(<span class="hljs-keyword">s</span>)</span><span class="hljs-comment">; js.id = id;</span>
                js.src = <span class="hljs-string">"//connect.facebook.net/en_GB/all.js#xfbml=1"</span><span class="hljs-comment">;</span>
                fjs.parentNode.insertBefore<span class="hljs-list">(<span class="hljs-keyword">js</span>, fjs)</span><span class="hljs-comment">;</span>
            }</span><span class="hljs-list">(<span class="hljs-keyword">document</span>, 'script', 'facebook-jssdk')</span>)</span><span class="hljs-comment">;</span></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar navbar-static-top navbar-inverse"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-inner"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-navbar"</span> <span class="hljs-attribute">data-toggle</span>=<span class="hljs-value">"collapse"</span> <span class="hljs-attribute">data-target</span>=<span class="hljs-value">".nav-collapse"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"icon-bar"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"brand"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"/"</span>&gt;</span>My Django Blog<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"nav-collapse collapse"</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span></span>
</code></pre><p>Now, the Facebook comment system requires that you pass through the absolute page URL when initialising the comments. At present we can’t do that without hard-coding the domain name in our template, which we want to avoid. So, we need to add a site field to each post to identify the site it’s associated with.</p><p>As usual, we update our tests first:</p><pre><code class="hljs lang-python"><span class="hljs-keyword">from</span> django.test <span class="hljs-keyword">import</span> TestCase, LiveServerTestCase, Client
<span class="hljs-keyword">from</span> django.utils <span class="hljs-keyword">import</span> timezone
<span class="hljs-keyword">from</span> blogengine.models <span class="hljs-keyword">import</span> Post
<span class="hljs-keyword">from</span> django.contrib.flatpages.models <span class="hljs-keyword">import</span> FlatPage
<span class="hljs-keyword">from</span> django.contrib.sites.models <span class="hljs-keyword">import</span> Site
<span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> User
<span class="hljs-keyword">import</span> markdown

<span class="hljs-comment"># Create your tests here.</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostTest</span><span class="hljs-params">(TestCase)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_post</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the site</span>
        site = Site()
        site.name = <span class="hljs-string">'example.com'</span>
        site.domain = <span class="hljs-string">'example.com'</span>
        site.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()

        <span class="hljs-comment"># Set the attributes</span>
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is my first blog post'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author
        post.site = site

        <span class="hljs-comment"># Save it</span>
        post.save()

        <span class="hljs-comment"># Check we can find it</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)
        only_post = all_posts[<span class="hljs-number">0</span>]
        self.assertEquals(only_post, post)

        <span class="hljs-comment"># Check attributes</span>
        self.assertEquals(only_post.title, <span class="hljs-string">'My first post'</span>)
        self.assertEquals(only_post.text, <span class="hljs-string">'This is my first blog post'</span>)
        self.assertEquals(only_post.slug, <span class="hljs-string">'my-first-post'</span>)
        self.assertEquals(only_post.site.name, <span class="hljs-string">'example.com'</span>)
        self.assertEquals(only_post.site.domain, <span class="hljs-string">'example.com'</span>)
        self.assertEquals(only_post.pub_date.day, post.pub_date.day)
        self.assertEquals(only_post.pub_date.month, post.pub_date.month)
        self.assertEquals(only_post.pub_date.year, post.pub_date.year)
        self.assertEquals(only_post.pub_date.hour, post.pub_date.hour)
        self.assertEquals(only_post.pub_date.minute, post.pub_date.minute)
        self.assertEquals(only_post.pub_date.second, post.pub_date.second)
        self.assertEquals(only_post.author.username, <span class="hljs-string">'testuser'</span>)
        self.assertEquals(only_post.author.email, <span class="hljs-string">'user@example.com'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseAcceptanceTest</span><span class="hljs-params">(LiveServerTestCase)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span><span class="hljs-params">(self)</span>:</span>
        self.client = Client()


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminTest</span><span class="hljs-params">(BaseAcceptanceTest)</span>:</span>
    fixtures = [<span class="hljs-string">'users.json'</span>]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_login</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Get login page</span>
        response = self.client.get(<span class="hljs-string">'/admin/'</span>)

        <span class="hljs-comment"># Check response code</span>
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check 'Log in' in response</span>
        self.assertTrue(<span class="hljs-string">'Log in'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Log the user in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Check response code</span>
        response = self.client.get(<span class="hljs-string">'/admin/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check 'Log out' in response</span>
        self.assertTrue(<span class="hljs-string">'Log out'</span> <span class="hljs-keyword">in</span> response.content)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_logout</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Log in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Check response code</span>
        response = self.client.get(<span class="hljs-string">'/admin/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check 'Log out' in response</span>
        self.assertTrue(<span class="hljs-string">'Log out'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Log out</span>
        self.client.logout()

        <span class="hljs-comment"># Check response code</span>
        response = self.client.get(<span class="hljs-string">'/admin/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check 'Log in' in response</span>
        self.assertTrue(<span class="hljs-string">'Log in'</span> <span class="hljs-keyword">in</span> response.content)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_post</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Log in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Check response code</span>
        response = self.client.get(<span class="hljs-string">'/admin/blogengine/post/add/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Create the new post</span>
        response = self.client.post(<span class="hljs-string">'/admin/blogengine/post/add/'</span>, {
            <span class="hljs-string">'title'</span>: <span class="hljs-string">'My first post'</span>,
            <span class="hljs-string">'text'</span>: <span class="hljs-string">'This is my first post'</span>,
            <span class="hljs-string">'pub_date_0'</span>: <span class="hljs-string">'2013-12-28'</span>,
            <span class="hljs-string">'pub_date_1'</span>: <span class="hljs-string">'22:00:04'</span>,
            <span class="hljs-string">'slug'</span>: <span class="hljs-string">'my-first-post'</span>,
            <span class="hljs-string">'site'</span>: <span class="hljs-string">'1'</span>
        },
        follow=<span class="hljs-keyword">True</span>
        )
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check added successfully</span>
        self.assertTrue(<span class="hljs-string">'added successfully'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check new post now in database</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_edit_post</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the site</span>
        site = Site()
        site.name = <span class="hljs-string">'example.com'</span>
        site.domain = <span class="hljs-string">'example.com'</span>
        site.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is my first blog post'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        <span class="hljs-comment"># Log in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Edit the post</span>
        response = self.client.post(<span class="hljs-string">'/admin/blogengine/post/1/'</span>, {
            <span class="hljs-string">'title'</span>: <span class="hljs-string">'My second post'</span>,
            <span class="hljs-string">'text'</span>: <span class="hljs-string">'This is my second blog post'</span>,
            <span class="hljs-string">'pub_date_0'</span>: <span class="hljs-string">'2013-12-28'</span>,
            <span class="hljs-string">'pub_date_1'</span>: <span class="hljs-string">'22:00:04'</span>,
            <span class="hljs-string">'slug'</span>: <span class="hljs-string">'my-second-post'</span>,
            <span class="hljs-string">'site'</span>: <span class="hljs-string">'1'</span>
        },
        follow=<span class="hljs-keyword">True</span>
        )
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check changed successfully</span>
        self.assertTrue(<span class="hljs-string">'changed successfully'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check post amended</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)
        only_post = all_posts[<span class="hljs-number">0</span>]
        self.assertEquals(only_post.title, <span class="hljs-string">'My second post'</span>)
        self.assertEquals(only_post.text, <span class="hljs-string">'This is my second blog post'</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_delete_post</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the site</span>
        site = Site()
        site.name = <span class="hljs-string">'example.com'</span>
        site.domain = <span class="hljs-string">'example.com'</span>
        site.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is my first blog post'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.site = site
        post.author = author
        post.save()

        <span class="hljs-comment"># Check new post saved</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)

        <span class="hljs-comment"># Log in</span>
        self.client.login(username=<span class="hljs-string">'bobsmith'</span>, password=<span class="hljs-string">"password"</span>)

        <span class="hljs-comment"># Delete the post</span>
        response = self.client.post(<span class="hljs-string">'/admin/blogengine/post/1/delete/'</span>, {
            <span class="hljs-string">'post'</span>: <span class="hljs-string">'yes'</span>
        }, follow=<span class="hljs-keyword">True</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check deleted successfully</span>
        self.assertTrue(<span class="hljs-string">'deleted successfully'</span> <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check post amended</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">0</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostViewTest</span><span class="hljs-params">(BaseAcceptanceTest)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_index</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the site</span>
        site = Site()
        site.name = <span class="hljs-string">'example.com'</span>
        site.domain = <span class="hljs-string">'example.com'</span>
        site.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is [my first blog post](http://127.0.0.1:8000/)'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        <span class="hljs-comment"># Check new post saved</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)

        <span class="hljs-comment"># Fetch the index</span>
        response = self.client.get(<span class="hljs-string">'/'</span>)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check the post title is in the response</span>
        self.assertTrue(post.title <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the post text is in the response</span>
        self.assertTrue(markdown.markdown(post.text) <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the post date is in the response</span>
        self.assertTrue(str(post.pub_date.year) <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(post.pub_date.strftime(<span class="hljs-string">'%b'</span>) <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(str(post.pub_date.day) <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the link is marked up properly</span>
        self.assertTrue(<span class="hljs-string">'&lt;a href="http://127.0.0.1:8000/"&gt;my first blog post&lt;/a&gt;'</span> <span class="hljs-keyword">in</span> response.content)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_post_page</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create the author</span>
        author = User.objects.create_user(<span class="hljs-string">'testuser'</span>, <span class="hljs-string">'user@example.com'</span>, <span class="hljs-string">'password'</span>)
        author.save()

        <span class="hljs-comment"># Create the site</span>
        site = Site()
        site.name = <span class="hljs-string">'example.com'</span>
        site.domain = <span class="hljs-string">'example.com'</span>
        site.save()

        <span class="hljs-comment"># Create the post</span>
        post = Post()
        post.title = <span class="hljs-string">'My first post'</span>
        post.text = <span class="hljs-string">'This is [my first blog post](http://127.0.0.1:8000/)'</span>
        post.slug = <span class="hljs-string">'my-first-post'</span>
        post.pub_date = timezone.now()
        post.author = author
        post.site = site
        post.save()

        <span class="hljs-comment"># Check new post saved</span>
        all_posts = Post.objects.all()
        self.assertEquals(len(all_posts), <span class="hljs-number">1</span>)
        only_post = all_posts[<span class="hljs-number">0</span>]
        self.assertEquals(only_post, post)

        <span class="hljs-comment"># Get the post URL</span>
        post_url = only_post.get_absolute_url()

        <span class="hljs-comment"># Fetch the post</span>
        response = self.client.get(post_url)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check the post title is in the response</span>
        self.assertTrue(post.title <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the post text is in the response</span>
        self.assertTrue(markdown.markdown(post.text) <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the post date is in the response</span>
        self.assertTrue(str(post.pub_date.year) <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(post.pub_date.strftime(<span class="hljs-string">'%b'</span>) <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(str(post.pub_date.day) <span class="hljs-keyword">in</span> response.content)

        <span class="hljs-comment"># Check the link is marked up properly</span>
        self.assertTrue(<span class="hljs-string">'&lt;a href="http://127.0.0.1:8000/"&gt;my first blog post&lt;/a&gt;'</span> <span class="hljs-keyword">in</span> response.content)


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlatPageViewTest</span><span class="hljs-params">(BaseAcceptanceTest)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_create_flat_page</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-comment"># Create flat page</span>
        page = FlatPage()
        page.url = <span class="hljs-string">'/about/'</span>
        page.title = <span class="hljs-string">'About me'</span>
        page.content = <span class="hljs-string">'All about me'</span>
        page.save()

        <span class="hljs-comment"># Add the site</span>
        page.sites.add(Site.objects.all()[<span class="hljs-number">0</span>])
        page.save()

        <span class="hljs-comment"># Check new page saved</span>
        all_pages = FlatPage.objects.all()
        self.assertEquals(len(all_pages), <span class="hljs-number">1</span>)
        only_page = all_pages[<span class="hljs-number">0</span>]
        self.assertEquals(only_page, page)

        <span class="hljs-comment"># Check data correct</span>
        self.assertEquals(only_page.url, <span class="hljs-string">'/about/'</span>)
        self.assertEquals(only_page.title, <span class="hljs-string">'About me'</span>)
        self.assertEquals(only_page.content, <span class="hljs-string">'All about me'</span>)

        <span class="hljs-comment"># Get URL</span>
        page_url = str(only_page.get_absolute_url())

        <span class="hljs-comment"># Get the page</span>
        response = self.client.get(page_url)
        self.assertEquals(response.status_code, <span class="hljs-number">200</span>)

        <span class="hljs-comment"># Check title and content in response</span>
        self.assertTrue(<span class="hljs-string">'About me'</span> <span class="hljs-keyword">in</span> response.content)
        self.assertTrue(<span class="hljs-string">'All about me'</span> <span class="hljs-keyword">in</span> response.content)
</code></pre><p>All we’ve done here is to add the <code>site</code> attribute when creating a new post using the Django database API, and when we create one via the admin, we add an additional <code>site</code> aparameter to the HTTP POST request with a value of 1. Run the tests and they should fail:</p><pre><code class="hljs lang-bash">Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
E........
======================================================================
ERROR: <span class="hljs-built_in">test</span>_create_post (blogengine.tests.PostTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File <span class="hljs-string">"/Users/matthewdaly/Projects/django_tutorial_blog_ng/blogengine/tests.py"</span>, line <span class="hljs-number">46</span>, <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span>_create_post
    self.assertEquals(only_post.site.name, <span class="hljs-string">'example.com'</span>)
AttributeError: <span class="hljs-string">'Post'</span> object has no attribute <span class="hljs-string">'site'</span>

----------------------------------------------------------------------
Ran <span class="hljs-number">9</span> tests <span class="hljs-keyword">in</span> <span class="hljs-number">4.313</span>s

FAILED (errors=<span class="hljs-number">1</span>)
Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
</code></pre><p>So we need to add the <code>site</code> attribute to the <code>Post</code> model. Let’s do that:</p><pre><code class="hljs lang-python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> models
<span class="hljs-keyword">from</span> django.contrib.auth.models <span class="hljs-keyword">import</span> User
<span class="hljs-keyword">from</span> django.contrib.sites.models <span class="hljs-keyword">import</span> Site

<span class="hljs-comment"># Create your models here.</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span><span class="hljs-params">(models.Model)</span>:</span>
    title = models.CharField(max_length=<span class="hljs-number">200</span>)
    pub_date = models.DateTimeField()
    text = models.TextField()
    slug = models.SlugField(max_length=<span class="hljs-number">40</span>, unique=<span class="hljs-keyword">True</span>)
    author = models.ForeignKey(User)
    site = models.ForeignKey(Site)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_absolute_url</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"/%s/%s/%s/"</span> % (self.pub_date.year, self.pub_date.month, self.slug)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__unicode__</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> self.title

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Meta</span>:</span>
        ordering = [<span class="hljs-string">"-pub_date"</span>]
</code></pre><p>Now create and run the migrations - you’ll be prompted to create a default value for the site attribute as well:</p><pre><code class="hljs lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py schemamigration --auto blogengine
 ? The field <span class="hljs-string">'Post.site'</span> does not have a default specified, yet is NOT NULL.
 ? Since you are adding this field, you MUST specify a default
 ? value to use <span class="hljs-keyword">for</span> existing rows. Would you like to:
 ?  <span class="hljs-number">1</span>. Quit now, and add a default to the field <span class="hljs-keyword">in</span> models.py
 ?  <span class="hljs-number">2</span>. Specify a one-off value to use <span class="hljs-keyword">for</span> existing columns now
 ? Please select a choice: <span class="hljs-number">2</span>
 ? Please enter Python code <span class="hljs-keyword">for</span> your one-off default value.
 ? The datetime module is available, so you can <span class="hljs-keyword">do</span> e.g. datetime.date.today()
 &gt;&gt;&gt; <span class="hljs-number">1</span>
 + Added field site on blogengine.Post
Created <span class="hljs-number">0005</span>_auto__add_field_post_site.py. You can now apply this migration with: ./manage.py migrate blogengine
(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py migrate
Running migrations <span class="hljs-keyword">for</span> blogengine:
 - Migrating forwards to <span class="hljs-number">0005</span>_auto__add_field_post_site.
 &gt; blogengine:<span class="hljs-number">0005</span>_auto__add_field_post_site
 - Loading initial data <span class="hljs-keyword">for</span> blogengine.
Installed <span class="hljs-number">0</span> object(s) from <span class="hljs-number">0</span> fixture(s)
</code></pre><p>Our tests should then pass:</p><pre><code class="hljs lang-bash">(venv)Smith:django_tutorial_blog_ng matthewdaly$ python manage.py <span class="hljs-built_in">test</span>
Creating <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
.........
----------------------------------------------------------------------
Ran <span class="hljs-number">9</span> tests <span class="hljs-keyword">in</span> <span class="hljs-number">4.261</span>s

OK
Destroying <span class="hljs-built_in">test</span> database <span class="hljs-keyword">for</span> <span class="hljs-built_in">alias</span> <span class="hljs-string">'default'</span>...
</code></pre><p>Now we can include our full page URL on the post detail page:</p><pre><code class="hljs lang-django"><span class="xml"></span><span class="hljs-template_tag">{% <span class="hljs-keyword">extends</span> "blogengine/includes/base.html" %}</span><span class="xml">

    </span><span class="hljs-template_tag">{% <span class="hljs-keyword">load</span> custom_markdown %}</span><span class="xml">

    </span><span class="hljs-template_tag">{% <span class="hljs-keyword">block</span> content %}</span><span class="xml">
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"post"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">h1</span>&gt;</span></span><span class="hljs-variable">{{ object.title }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">h3</span>&gt;</span></span><span class="hljs-variable">{{ object.pub_date }}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-title">h3</span>&gt;</span>
        </span><span class="hljs-variable">{{ object.text<span class="hljs-filter">|custom</span>_markdown }}</span><span class="xml">

        <span class="hljs-tag">&lt;<span class="hljs-title">h4</span>&gt;</span>Comments<span class="hljs-tag">&lt;/<span class="hljs-title">h4</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"fb-comments"</span> <span class="hljs-attribute">data-href</span>=<span class="hljs-value">"http://</span></span></span><span class="hljs-variable">{{ post.site }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-value"></span></span></span><span class="hljs-variable">{{ post.get_absolute_url }}</span><span class="xml"><span class="hljs-tag"><span class="hljs-value">"</span> <span class="hljs-attribute">data-width</span>=<span class="hljs-value">"470"</span> <span class="hljs-attribute">data-num-posts</span>=<span class="hljs-value">"10"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>

        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>

    </span><span class="hljs-template_tag">{% <span class="hljs-keyword">endblock</span> %}</span><span class="xml"></span>
</code></pre><p>If you want to customise the comments, take a look at <a href="https://developers.facebook.com/docs/plugins/comments/">the documentation for Facebook Comments</a>.</p><p>With that done, we can commit our changes:</p><pre><code class="hljs lang-bash">$ git add blogengine/ templates/
$ git commit -m <span class="hljs-string">'Implemented Facebook comments'</span>
</code></pre><p>And that wraps up this lesson. As usual, you can easily switch to today’s lesson with <code>git checkout lesson-3</code>. Next time we’ll implement categories and tags, and create an RSS feed for our blog posts.</p><ul class="categorylist"><li><a href="/blog/categories/python/">python</a></li><li><a href="/blog/categories/django/">django</a></li><li><a href="/blog/categories/tdd/">tdd</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script type="text/javascript">window.disqus_identifier="http://matthewdaly.co.uk/blog/2014/01/03/django-blog-tutorial-the-next-generation-part-3/";
                    window.disqus_url="http://matthewdaly.co.uk/blog/2014/01/03/django-blog-tutorial-the-next-generation-part-3/";
                    window.disqus_title="Django Blog Tutorial - the Next Generation - Part 3";</script><script type="text/javascript" src="http://disqus.com/forums/matthewdaly/embed.js"></script><noscript><a href="http://matthewdaly.disqus.com/?url=ref">View the discussion thread.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2015/04/18/how-i-added-search-to-my-site-with-lunr-dot-js/">How I Added Search to My Site With Lunr.js</a></p><p><a href="/blog/2015/04/04/adding-a-new-search-engine-to-my-site/">Adding a New Search Engine to My Site</a></p><p><a href="/blog/2015/03/02/syntax-highlighting-in-fenced-code-blocks-in-vim/">Syntax Highlighting in Fenced Code Blocks in Vim</a></p><p><a href="/blog/2015/03/02/extending-our-node-dot-js-and-redis-chat-server/">Extending Our Node.js and Redis Chat Server</a></p><p><a href="/blog/2015/02/15/switching-to-my-own-static-site-generator/">Switching to My Own Static Site Generator</a></p><section id="github-profile"></section><h4>My GitHub repositories</h4><ul id="github-repos"><li>Loading repositories...</li></ul></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/blog/2014/01/25/my-first-yeoman-generator/">My First Yeoman Generator</a></li><li><a href="/blog/2014/01/02/django-blog-tutorial-the-next-generation-part-2/">Django Blog Tutorial - the Next Generation - Part 2</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2015.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script></body></html>