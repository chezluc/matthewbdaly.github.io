<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
        <meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog...">
        
        <link href='http://fonts.googleapis.com/css?family=PT+Serif' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" href="/static/bower_components/sass-bootstrap/dist/css/bootstrap.min.css" media="all" />
        <link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all" />
        <link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml" />
        <title>Building a Chat Server With Node.js and Redis - Matthew Daly&#x27;s Blog</title>
    </head>
    <body>

        <!-- Go to www.addthis.com/dashboard to customize your tools -->
        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script>

        <header>
            <nav class="navbar navbar-inverse navbar-static-top">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="header-nav">
                            <ul class="nav navbar-nav">
                                <li><a href="/">Home</a></li>
                                <li><a href="/blog/archives/">Archives</a></li>
                                <li><a href="/about/">About</a></li>
                                <li><a href="/atom.xml">RSS</a></li>
                            </ul>
                            <form action="http://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right">
                                <div class="form-group">
                                    <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" class="form-control"></input>
                                </div>
                                <input id="site" name="q" type="hidden" value="site:matthewdaly.co.uk" />
                                <input type="submit" class="btn btn-default"></input>
                            </form>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="container">
                <div class="page-header">
                    <h1><a href="/">Matthew Daly&#x27;s Blog</a></h1>
                    <h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2>
                </div>
            </div>
        </header>

<div class="container">


    <div class="row">
        <div class="col-md-8">
            <article class="post">
                <p class="date">31st December 2014 2:10 pm</p>
                <h1>Building a Chat Server With Node.js and Redis</h1>
                <p>One of the more interesting capabilities Redis offers is its support for Pub/Sub. This allows you to subscribe to a specific channel, and then react when some content is published to that channel. In this tutorial, we’ll build a very simple web-based chat system that demonstrates Redis’s Pub/Sub support in action. Chat systems are pretty much synonymous with Node.js - it’s widely considered the “Hello, World!” of Node.js. Since we already used Node with the prior Redis tutorial, then it also makes sense to stick with it for this project too.</p>
<h2 id="installing-node-js">Installing Node.js</h2>
<p>Since the last tutorial, I’ve discovered <a href="https://github.com/creationix/nvm">NVM</a>, and if you’re using any flavour of Unix, I highly recommend using it. It’s not an option if you’re using Windows, however Redis doesn’t officially support Windows anyway, so if you want to follow along on a Windows machine I’d recommend using a VM.</p>
<p>If you followed the URL shortener tutorial, you should already have everything you need, though I’d still recommend switching to NVM as it’s very convenient. We’ll be using Grunt again, so you’ll need to make sure you have <code>grunt-cli</code> installed with the following command:</p>
<pre><code class="hljs lang-bash">$ npm install -g grunt-cli
</code></pre>
<p>This assumes you used NVM to install Node - if it’s installed globally, you may need to use <code>sudo</code>.</p>
<h2 id="installing-dependencies">Installing dependencies</h2>
<p>As usual with a Node.js project, our first step is to create our <code>package.json</code> file:</p>
<pre><code class="hljs lang-bash">$ npm init
</code></pre>
<p>Answer the questions so you end up with something like this (or just paste this into <code>package.json</code> and amend it as you see fit):</p>
<pre><code class="hljs lang-json">{
  "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"babblr"</span></span>,
  "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"1.0.0"</span></span>,
  "<span class="hljs-attribute">description</span>": <span class="hljs-value"><span class="hljs-string">"Chat client"</span></span>,
  "<span class="hljs-attribute">main</span>": <span class="hljs-value"><span class="hljs-string">"index.js"</span></span>,
  "<span class="hljs-attribute">scripts</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">test</span>": <span class="hljs-value"><span class="hljs-string">"grunt test --verbose"</span>
  </span>}</span>,
  "<span class="hljs-attribute">keywords</span>": <span class="hljs-value">[
    <span class="hljs-string">"chat"</span>
  ]</span>,
  "<span class="hljs-attribute">author</span>": <span class="hljs-value"><span class="hljs-string">"Matthew Daly &lt;matthew@matthewdaly.co.uk&gt; (http://matthewdaly.co.uk/)"</span></span>,
  "<span class="hljs-attribute">license</span>": <span class="hljs-value"><span class="hljs-string">"GPLv2"</span>
</span>}
</code></pre>
<p>Now let’s install our dependencies:</p>
<pre><code class="hljs lang-bash">$ npm install express hbs redis hiredis socket.io socket.io-client --save
$ npm install chai grunt grunt-contrib-jshint grunt-coveralls grunt-mocha-istanbul istanbul mocha request --save-dev
</code></pre>
<p>These two commands will install our dependencies.</p>
<p>Now, if you followed on with the URL shortener tutorial, you’ll notice that we aren’t using Jade - instead we’re going to use Handlebars. Jade is quite a nice templating system, but I find it gets in the way for larger projects - you spend too much time looking up the syntax for things you already know in HTML. Handlebars is closer to HTML so we will use that. We’ll also use Socket.IO extensively on this project.</p>
<h2 id="support-files">Support files</h2>
<p>As before, we’ll also use Mocha for our unit tests and Istanbul to generate coverage stats. We’ll need a Grunt configuration for that, so here it is:</p>
<pre><code class="hljs lang-javascript"><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(grunt)</span> </span>{
<span class="hljs-pi">    'use strict'</span>;

    grunt.initConfig({
        jshint: {
            all: [
                <span class="hljs-string">'test/*.js'</span>,
                <span class="hljs-string">'index.js'</span>
            ]
        },
        mocha_istanbul: {
            coverage: {
                src: <span class="hljs-string">'test'</span>, <span class="hljs-comment">// the folder, not the files,</span>
                options: {
                    mask: <span class="hljs-string">'*.js'</span>,
                    reportFormats: [<span class="hljs-string">'cobertura'</span>, <span class="hljs-string">'html'</span>, <span class="hljs-string">'lcovonly'</span>]
                }
            }
        },
        coveralls: {
            options: {
                src: <span class="hljs-string">'coverage/lcov.info'</span>,
                force: <span class="hljs-literal">false</span>
            },
            app: {
                src: <span class="hljs-string">'coverage/lcov.info'</span>
            }
        }
    });

    <span class="hljs-comment">// Load tasks</span>
    grunt.loadNpmTasks(<span class="hljs-string">'grunt-contrib-jshint'</span>);
    grunt.loadNpmTasks(<span class="hljs-string">'grunt-coveralls'</span>);
    grunt.loadNpmTasks(<span class="hljs-string">'grunt-mocha-istanbul'</span>);

    <span class="hljs-comment">// Register tasks</span>
    grunt.registerTask(<span class="hljs-string">'test'</span>, [<span class="hljs-string">'jshint'</span>, <span class="hljs-string">'mocha_istanbul:coverage'</span>, <span class="hljs-string">'coveralls'</span>]);
};
</code></pre>
<p>We also need a <code>.bowerrc</code>:</p>
<pre><code class="hljs lang-json">{
    "<span class="hljs-attribute">directory</span>": <span class="hljs-value"><span class="hljs-string">"static/bower_components"</span>
</span>}
</code></pre>
<p>And a <code>bower.json</code>:</p>
<pre><code class="hljs lang-json">{
  "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"babblr"</span></span>,
  "<span class="hljs-attribute">main</span>": <span class="hljs-value"><span class="hljs-string">"index.js"</span></span>,
  "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"1.0.0"</span></span>,
  "<span class="hljs-attribute">authors</span>": <span class="hljs-value">[
    <span class="hljs-string">"Matthew Daly &lt;matthewbdaly@gmail.com&gt;"</span>
  ]</span>,
  "<span class="hljs-attribute">description</span>": <span class="hljs-value"><span class="hljs-string">"A simple chat server"</span></span>,
  "<span class="hljs-attribute">moduleType</span>": <span class="hljs-value">[
    <span class="hljs-string">"node"</span>
  ]</span>,
  "<span class="hljs-attribute">keywords</span>": <span class="hljs-value">[
    <span class="hljs-string">"chat"</span>
  ]</span>,
  "<span class="hljs-attribute">license</span>": <span class="hljs-value"><span class="hljs-string">"GPLv2"</span></span>,
  "<span class="hljs-attribute">homepage</span>": <span class="hljs-value"><span class="hljs-string">"http://www.matthewdaly.co.uk"</span></span>,
  "<span class="hljs-attribute">private</span>": <span class="hljs-value"><span class="hljs-literal">true</span></span>,
  "<span class="hljs-attribute">ignore</span>": <span class="hljs-value">[
    <span class="hljs-string">"**/.*"</span>,
    <span class="hljs-string">"node_modules"</span>,
    <span class="hljs-string">"bower_components"</span>,
    <span class="hljs-string">"test"</span>,
    <span class="hljs-string">"tests"</span>
  ]</span>,
  "<span class="hljs-attribute">dependencies</span>": <span class="hljs-value">{
    "<span class="hljs-attribute">html5-boilerplate</span>": <span class="hljs-value"><span class="hljs-string">"~4.3.0"</span></span>,
    "<span class="hljs-attribute">jquery</span>": <span class="hljs-value"><span class="hljs-string">"~2.1.1"</span></span>,
    "<span class="hljs-attribute">bootstrap</span>": <span class="hljs-value"><span class="hljs-string">"~3.3.1"</span>
  </span>}
</span>}
</code></pre>
<p>Then install the Bower dependencies:</p>
<pre><code class="hljs lang-bash">$ bower install
</code></pre>
<p>We also need a <code>Procfile</code> so we can run it on Heroku:</p>
<pre><code class="hljs lang-bash">web: node index.js
</code></pre>
<p>Now, let’s create the main file:</p>
<pre><code class="hljs lang-bash">$ touch index.js
</code></pre>
<p>And our test file:</p>
<pre><code class="hljs lang-bash">$ mkdir <span class="hljs-built_in">test</span>
$ touch <span class="hljs-built_in">test</span>/test.js
</code></pre>
<h2 id="implementing-the-chat-server">Implementing the chat server</h2>
<p>Next, let’s implement our first test. First of all, we’ll verify that the index route works:</p>
<pre><code class="hljs lang-javascript"><span class="hljs-comment">/*jslint node: true */</span>
<span class="hljs-comment">/*global describe: false, before: false, after: false, it: false */</span>
<span class="hljs-pi">"use strict"</span>;

<span class="hljs-comment">// Declare the variables used</span>
<span class="hljs-keyword">var</span> expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).expect,
    request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>),
    server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../index'</span>),
    redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>),
    io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io-client'</span>),
    client;
client = redis.createClient();

<span class="hljs-comment">// Server tasks</span>
describe(<span class="hljs-string">'server'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// Beforehand, start the server</span>
    before(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Starting the server'</span>);
        done();
    });

    <span class="hljs-comment">// Afterwards, stop the server and empty the database</span>
    after(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Stopping the server'</span>);
        client.flushdb();
        done();
    });

    <span class="hljs-comment">// Test the index route</span>
    describe(<span class="hljs-string">'Test the index route'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        it(<span class="hljs-string">'should return a page with the title Babblr'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
            request.get({ url: <span class="hljs-string">'http://localhost:5000/'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, response, body)</span> </span>{
                expect(body).to.include(<span class="hljs-string">'Babblr'</span>);
                expect(response.statusCode).to.equal(<span class="hljs-number">200</span>);
                expect(response.headers[<span class="hljs-string">'content-type'</span>]).to.equal(<span class="hljs-string">'text/html; charset=utf-8'</span>);
                done();
            });
        });
    });
});
</code></pre>
<p>Note that this is very similar to the first test for the URL shortener, because it’s doing basically the same thing.</p>
<p>Now, run the test and make sure it fails:</p>
<pre><code class="hljs lang-bash">$ grunt <span class="hljs-built_in">test</span>
Running <span class="hljs-string">"jshint:all"</span> (jshint) task
&gt;&gt; <span class="hljs-number">2</span> files lint free.

Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task


  server
Starting the server
    Test the index route
      <span class="hljs-number">1</span>) should <span class="hljs-built_in">return</span> a page with the title Babblr
Stopping the server


  <span class="hljs-number">0</span> passing (<span class="hljs-number">873</span>ms)
  <span class="hljs-number">1</span> failing

  <span class="hljs-number">1</span>) server Test the index route should <span class="hljs-built_in">return</span> a page with the title Babblr:
     Uncaught AssertionError: expected undefined to include <span class="hljs-string">'Babblr'</span>
      at Request._callback (/Users/matthewdaly/Projects/babblr/<span class="hljs-built_in">test</span>/test.js:<span class="hljs-number">34</span>:<span class="hljs-number">33</span>)
      at self.callback (/Users/matthewdaly/Projects/babblr/node_modules/request/request.js:<span class="hljs-number">373</span>:<span class="hljs-number">22</span>)
      at Request.emit (events.js:<span class="hljs-number">95</span>:<span class="hljs-number">17</span>)
      at Request.onRequestError (/Users/matthewdaly/Projects/babblr/node_modules/request/request.js:<span class="hljs-number">971</span>:<span class="hljs-number">8</span>)
      at ClientRequest.emit (events.js:<span class="hljs-number">95</span>:<span class="hljs-number">17</span>)
      at Socket.socketErrorListener (http.js:<span class="hljs-number">1552</span>:<span class="hljs-number">9</span>)
      at Socket.emit (events.js:<span class="hljs-number">95</span>:<span class="hljs-number">17</span>)
      at net.js:<span class="hljs-number">441</span>:<span class="hljs-number">14</span>
      at process._tickCallback (node.js:<span class="hljs-number">442</span>:<span class="hljs-number">13</span>)



=============================================================================
Writing coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]
Writing coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]
=============================================================================

=============================== Coverage summary ===============================
Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
================================================================================
&gt;&gt;
Warning: Task <span class="hljs-string">"mocha_istanbul:coverage"</span> failed. Use --force to continue.

Aborted due to warnings.
</code></pre>
<p>With that confirmed, we can start writing code to make the test pass:</p>
<pre><code class="hljs lang-javascript"><span class="hljs-comment">/*jslint node: true */</span>
<span class="hljs-pi">'use strict'</span>;

<span class="hljs-comment">// Declare variables used</span>
<span class="hljs-keyword">var</span> app, base_url, client, express, hbs, io, port, rtg, subscribe;

<span class="hljs-comment">// Define values</span>
express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
app = express();
port = process.env.PORT || <span class="hljs-number">5000</span>;
base_url = process.env.BASE_URL || <span class="hljs-string">'http://localhost:5000'</span>;
hbs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>);

<span class="hljs-comment">// Set up connection to Redis</span>
<span class="hljs-comment">/* istanbul ignore if */</span>
<span class="hljs-keyword">if</span> (process.env.REDISTOGO_URL) {
    rtg  = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>).parse(process.env.REDISTOGO_URL);
    client = <span class="hljs-built_in">require</span>(<span class="hljs-string">"redis"</span>).createClient(rtg.port, rtg.hostname);
    subscribe = <span class="hljs-built_in">require</span>(<span class="hljs-string">"redis"</span>).createClient(rtg.port, rtg.hostname);
    client.auth(rtg.auth.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">1</span>]);
    subscribe.auth(rtg.auth.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">1</span>]);
} <span class="hljs-keyword">else</span> {
    client = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();
    subscribe = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();
}

<span class="hljs-comment">// Set up templating</span>
app.set(<span class="hljs-string">'views'</span>, __dirname + <span class="hljs-string">'/views'</span>);
app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">"hbs"</span>);
app.engine(<span class="hljs-string">'hbs'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>).__express);

<span class="hljs-comment">// Register partials</span>
hbs.registerPartials(__dirname + <span class="hljs-string">'/views/partials'</span>);

<span class="hljs-comment">// Set URL</span>
app.set(<span class="hljs-string">'base_url'</span>, base_url);

<span class="hljs-comment">// Define index route</span>
app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> </span>{
    res.render(<span class="hljs-string">'index'</span>);
});

<span class="hljs-comment">// Serve static files</span>
app.use(express.static(__dirname + <span class="hljs-string">'/static'</span>));

<span class="hljs-comment">// Listen</span>
io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>)({
}).listen(app.listen(port));
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Listening on port "</span> + port);
</code></pre>
<p>If you compare this to the code for the URL shortener, you’ll notice a few fairly substantial differences. For one thing, we set up two Redis connections, not one - that’s because we need to do so when using Pub/Sub with Redis. You’ll also notice that we register Handlebars (<code>hbs</code>) rather than Jade, and define not just a directory for views, but another directory inside it for partials. Finally, setting it up to listen at the end is a bit more involved because we’ll be using Socket.IO.</p>
<p>Now, you can run your tests again at this point, but they won’t pass because we haven’t created our views. So let’s do that. Create the directory <code>views</code> and the subdirectory <code>partials</code> inside it. Then add the following content to <code>views/index.hbs</code>:</p>
<pre><code class="hljs lang-hbs"><span class="xml"></span><span class="hljs-expression">{{&gt; <span class="hljs-variable">header</span> }}</span><span class="xml">
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"row"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-md-8"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"conversation"</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-md-4"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">form</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-group"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"message"</span>&gt;</span>Message<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-title">textarea</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-control"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"message"</span> <span class="hljs-attribute">rows</span>=<span class="hljs-value">"20"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">textarea</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"submitbutton"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-primary form-control"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
</span><span class="hljs-expression">{{&gt; <span class="hljs-variable">footer</span> }}</span><span class="xml"></span>
</code></pre>
<p>Add this to <code>views/partials/header.hbs</code>:</p>
<pre><code class="hljs lang-hbs"><span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-comment">&lt;!--[if lt IE 7]&gt;      &lt;html class="no-js lt-ie9 lt-ie8 lt-ie7"&gt; &lt;![endif]--&gt;</span>
<span class="hljs-comment">&lt;!--[if IE 7]&gt;         &lt;html class="no-js lt-ie9 lt-ie8"&gt; &lt;![endif]--&gt;</span>
<span class="hljs-comment">&lt;!--[if IE 8]&gt;         &lt;html class="no-js lt-ie9"&gt; &lt;![endif]--&gt;</span>
<span class="hljs-comment">&lt;!--[if gt IE 8]&gt;&lt;!--&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">html</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"no-js"</span>&gt;</span> <span class="hljs-comment">&lt;!--&lt;![endif]--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">http-equiv</span>=<span class="hljs-value">"X-UA-Compatible"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"IE=edge"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>Babblr<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"description"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">""</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"viewport"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"width=device-width, initial-scale=1"</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Place favicon.ico and apple-touch-icon.png in the root directory --&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"/bower_components/bootstrap/dist/css/bootstrap.min.css"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"/bower_components/bootstrap/dist/css/bootstrap-theme.min.css"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"/css/style.css"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
        <span class="hljs-comment">&lt;!--[if lt IE 7]&gt;
            &lt;p class="browsehappy"&gt;You are using an &lt;strong&gt;outdated&lt;/strong&gt; browser. Please &lt;a href="http://browsehappy.com/"&gt;upgrade your browser&lt;/a&gt; to improve your experience.&lt;/p&gt;
        &lt;![endif]--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">nav</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar navbar-inverse navbar-static-top"</span> <span class="hljs-attribute">role</span>=<span class="hljs-value">"navigation"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-header"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-brand"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"#"</span>&gt;</span>Babblr<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">nav</span>&gt;</span>
</code></pre>
<p>And add this to <code>views/partials/footer.hbs</code>:</p>
<pre><code class="hljs lang-hbs">
        <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"/bower_components/jquery/dist/jquery.min.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"/bower_components/bootstrap/dist/js/bootstrap.min.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"/socket.io/socket.io.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"/js/main.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre>
<p>You’ll also want to create placeholder CSS and JavaScript files:</p>
<pre><code class="hljs lang-bash">$ mkdir static/js
$ mkdir static/css
$ touch static/js/main.js
$ touch static/css/style.css
</code></pre>
<p>The test should now pass:</p>
<pre><code class="hljs lang-bash">$ grunt <span class="hljs-built_in">test</span>
Running <span class="hljs-string">"jshint:all"</span> (jshint) task
&gt;&gt; <span class="hljs-number">2</span> files lint free.

Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
Listening on port <span class="hljs-number">5000</span>


  server
Starting the server
    Test the index route
      ✓ should <span class="hljs-built_in">return</span> a page with the title Babblr (<span class="hljs-number">41</span>ms)
Stopping the server


  <span class="hljs-number">1</span> passing (<span class="hljs-number">54</span>ms)

=============================================================================
Writing coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]
Writing coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]
=============================================================================

=============================== Coverage summary ===============================
Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">24</span>/<span class="hljs-number">24</span> ), <span class="hljs-number">5</span> ignored
Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">6</span>/<span class="hljs-number">6</span> ), <span class="hljs-number">1</span> ignored
Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">1</span>/<span class="hljs-number">1</span> )
Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">24</span>/<span class="hljs-number">24</span> )
================================================================================
&gt;&gt; Done. Check coverage folder.

Running <span class="hljs-string">"coveralls:app"</span> (coveralls) task
&gt;&gt; Failed to submit <span class="hljs-string">'coverage/lcov.info'</span> to coveralls: Bad response: <span class="hljs-number">422</span> {<span class="hljs-string">"message"</span>:<span class="hljs-string">"Couldn't find a repository matching this job."</span>,<span class="hljs-string">"error"</span>:<span class="hljs-literal">true</span>}
&gt;&gt; Failed to submit coverage results to coveralls
Warning: Task <span class="hljs-string">"coveralls:app"</span> failed. Use --force to continue.

Aborted due to warnings.
</code></pre>
<p>Don’t worry about the coveralls task failing, as that only needs to pass when it runs on Travis CI.</p>
<p>So we now have our main route in place. The next step is to actually implement the chat functionality. Add this code to the test file:</p>
<pre><code class="hljs lang-javascript">
    <span class="hljs-comment">// Test sending a message</span>
    describe(<span class="hljs-string">'Test sending a message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        it(<span class="hljs-string">"should return 'Message received'"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
            <span class="hljs-comment">// Connect to server</span>
            <span class="hljs-keyword">var</span> socket = io.connect(<span class="hljs-string">'http://localhost:5000'</span>, {
                <span class="hljs-string">'reconnection delay'</span> : <span class="hljs-number">0</span>,
                <span class="hljs-string">'reopen delay'</span> : <span class="hljs-number">0</span>,
                <span class="hljs-string">'force new connection'</span> : <span class="hljs-literal">true</span>
            });

            <span class="hljs-comment">// Handle the message being received</span>
            socket.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
                expect(data).to.include(<span class="hljs-string">'Message received'</span>);
                socket.disconnect();
                done();
            });

            <span class="hljs-comment">// Send the message</span>
            socket.emit(<span class="hljs-string">'send'</span>, { message: <span class="hljs-string">'Message received'</span> });
        });
    });
</code></pre>
<p>This code should be fairly straightforward to understand. First, we connect to the server. Then, we set up a handler to verify the content of the message when it gets sent. Finally, we send the message. Let’s run the tests to make sure we get the expected result:</p>
<pre><code class="hljs lang-bash">$ grunt <span class="hljs-built_in">test</span>
Running <span class="hljs-string">"jshint:all"</span> (jshint) task
&gt;&gt; <span class="hljs-number">2</span> files lint free.

Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
Listening on port <span class="hljs-number">5000</span>


  server
Starting the server
    Test the index route
      ✓ should <span class="hljs-built_in">return</span> a page with the title Babblr (<span class="hljs-number">337</span>ms)
    Test sending a message
      <span class="hljs-number">1</span>) should <span class="hljs-built_in">return</span> <span class="hljs-string">'Message received'</span>
Stopping the server


  <span class="hljs-number">1</span> passing (<span class="hljs-number">2</span>s)
  <span class="hljs-number">1</span> failing

  <span class="hljs-number">1</span>) server Test sending a message should <span class="hljs-built_in">return</span> <span class="hljs-string">'Message received'</span>:
     Error: timeout of <span class="hljs-number">2000</span>ms exceeded
      at null.&lt;anonymous&gt; (/Users/matthewdaly/Projects/babblr/node_modules/mocha/lib/runnable.js:<span class="hljs-number">159</span>:<span class="hljs-number">19</span>)
      at Timer.listOnTimeout [as ontimeout] (timers.js:<span class="hljs-number">112</span>:<span class="hljs-number">15</span>)



=============================================================================
Writing coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]
Writing coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]
=============================================================================

=============================== Coverage summary ===============================
Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">24</span>/<span class="hljs-number">24</span> ), <span class="hljs-number">5</span> ignored
Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">6</span>/<span class="hljs-number">6</span> ), <span class="hljs-number">1</span> ignored
Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">1</span>/<span class="hljs-number">1</span> )
Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">24</span>/<span class="hljs-number">24</span> )
================================================================================
&gt;&gt;
Warning: Task <span class="hljs-string">"mocha_istanbul:coverage"</span> failed. Use --force to continue.

Aborted due to warnings.
</code></pre>
<p>Now, let’s implement this functionality. Add this at the end of <code>index.js</code>:</p>
<pre><code class="hljs lang-javascript"><span class="hljs-comment">// Handle new messages</span>
io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(socket)</span> </span>{
    <span class="hljs-comment">// Subscribe to the Redis channel</span>
    subscribe.subscribe(<span class="hljs-string">'ChatChannel'</span>);

    <span class="hljs-comment">// Handle incoming messages</span>
    socket.on(<span class="hljs-string">'send'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
        <span class="hljs-comment">// Publish it</span>
        client.publish(<span class="hljs-string">'ChatChannel'</span>, data.message);
    });

    <span class="hljs-comment">// Handle receiving messages</span>
    <span class="hljs-keyword">var</span> callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(channel, data)</span> </span>{
        socket.emit(<span class="hljs-string">'message'</span>, data);
    };
    subscribe.on(<span class="hljs-string">'message'</span>, callback);

    <span class="hljs-comment">// Handle disconnect</span>
    socket.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        subscribe.removeListener(<span class="hljs-string">'message'</span>, callback);
    });
});
</code></pre>
<p>We’ll go through this. First, we create a callback for when a new connection is received. Inside the callback, we then subscribe to a Pub/Sub channel in Redis called <code>ChatChannel</code>.</p>
<p>Then, we define another callback so that on a <code>send</code> event from Socket.IO, we get the message and publish it to <code>ChatChannel</code>. After that, we define another callback to handle receiving messages, and set it to run when a new message is published to <code>ChatChannel</code>. Finally, we set up a callback to handle removing the listener when a user disconnects.</p>
<p>Note the two different connections to Redis - <code>client</code> and <code>subscribe</code>. As mentioned earlier, you need to use two connections to Redis when using Pub/Sub. This is because a client subscribed to one or more channels should not issue commands, so we use <code>subscribe</code> as a dedicated connection to handle subscriptions, and use <code>client</code> to publish new messages.</p>
<p>We’ll also need a bit of client-side JavaScript to handle sending and receiving messages. Amend <code>main.js</code> as follows:</p>
<pre><code class="hljs lang-javascript">$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="hljs-pi">    'use strict'</span>;

    <span class="hljs-comment">// Set up the connection</span>
    <span class="hljs-keyword">var</span> field, socket, output;
    socket = io.connect(<span class="hljs-built_in">window</span>.location.href);

    <span class="hljs-comment">// Get a reference to the input</span>
    field = $(<span class="hljs-string">'textarea#message'</span>);

    <span class="hljs-comment">// Get a reference to the output</span>
    output = $(<span class="hljs-string">'div.conversation'</span>);

    <span class="hljs-comment">// Handle message submit</span>
    $(<span class="hljs-string">'a#submitbutton'</span>).on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// Create the message</span>
        <span class="hljs-keyword">var</span> msg;
        msg = field.val();
        socket.emit(<span class="hljs-string">'send'</span>, { message: msg });
        field.val(<span class="hljs-string">''</span>);
    });

    <span class="hljs-comment">// Handle incoming messages</span>
    socket.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
        <span class="hljs-comment">// Insert the message</span>
        output.append(<span class="hljs-string">'&lt;p&gt;Anonymous Coward : '</span> + data + <span class="hljs-string">'&lt;/p&gt;'</span>);
    });
});
</code></pre>
<p>Here we have one callback that handles sending messages, and another that handles receiving messages. Note that every message will be preceded with Anonymous Coward - we won’t implement user names at this point (though I plan it for a future instalment).</p>
<p>We’ll also add a little bit of additional styling:</p>
<pre><code class="hljs lang-css"><span class="hljs-tag">div</span><span class="hljs-class">.conversation</span> <span class="hljs-rules">{
    <span class="hljs-rule"><span class="hljs-attribute">height</span>:<span class="hljs-value"> <span class="hljs-number">500px</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">overflow-y</span>:<span class="hljs-value"> scroll</span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">border</span>:<span class="hljs-value"> <span class="hljs-number">1px</span> solid <span class="hljs-hexcolor">#000</span></span></span>;
    <span class="hljs-rule"><span class="hljs-attribute">padding</span>:<span class="hljs-value"> <span class="hljs-number">10px</span></span></span>;
<span class="hljs-rule">}</span></span>
</code></pre>
<p>Now, if you run your tests, they should pass:</p>
<pre><code class="hljs lang-bash">$ grunt <span class="hljs-built_in">test</span>
Running <span class="hljs-string">"jshint:all"</span> (jshint) task
&gt;&gt; <span class="hljs-number">2</span> files lint free.

Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
Listening on port <span class="hljs-number">5000</span>


  server
Starting the server
    Test the index route
      ✓ should <span class="hljs-built_in">return</span> a page with the title Babblr (<span class="hljs-number">40</span>ms)
    Test sending a message
      ✓ should <span class="hljs-built_in">return</span> <span class="hljs-string">'Message received'</span> (<span class="hljs-number">45</span>ms)
Stopping the server


  <span class="hljs-number">2</span> passing (<span class="hljs-number">101</span>ms)

=============================================================================
Writing coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]
Writing coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]
=============================================================================

=============================== Coverage summary ===============================
Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">33</span>/<span class="hljs-number">33</span> ), <span class="hljs-number">5</span> ignored
Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">6</span>/<span class="hljs-number">6</span> ), <span class="hljs-number">1</span> ignored
Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">5</span>/<span class="hljs-number">5</span> )
Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">33</span>/<span class="hljs-number">33</span> )
================================================================================
&gt;&gt; Done. Check coverage folder.

Running <span class="hljs-string">"coveralls:app"</span> (coveralls) task
&gt;&gt; Failed to submit <span class="hljs-string">'coverage/lcov.info'</span> to coveralls: Bad response: <span class="hljs-number">422</span> {<span class="hljs-string">"message"</span>:<span class="hljs-string">"Couldn't find a repository matching this job."</span>,<span class="hljs-string">"error"</span>:<span class="hljs-literal">true</span>}
&gt;&gt; Failed to submit coverage results to coveralls
Warning: Task <span class="hljs-string">"coveralls:app"</span> failed. Use --force to continue.

Aborted due to warnings.
</code></pre>
<p>If you now run the following command:</p>
<pre><code class="hljs lang-bash">$ node index.js
</code></pre>
<p>Then visit <code>http://localhost:5000</code>, you should be able to create new messages. If you then open it up in a second tab, you can see messages added in one tab appear in another. Deploying to Heroku using Redis To Go will be straightforward, and you can then access it from multiple devices and see new chat messages appear in real time.</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>This illustrates just how straightforward it is to use Redis’s Pub/Sub capability. The chat system is still quite limited, so in a future instalment we’ll develop it further. You can get the source code from the <a href="https://github.com/matthewbdaly/babblr">Github repository</a> - just switch to the <code>lesson-1</code> tag.</p>

                <ul class="categorylist"><li><a href="/blog/categories/node-js/">node.js</a></li><li><a href="/blog/categories/redis/">redis</a></li></ul>
                <div class="addthis_sharing_toolbox"></div>
              <section class="comments">
                  <div id="disqus_thread"></div>
                  <script type="text/javascript">
                    window.disqus_identifier="http://matthewdaly.co.uk/blog/2014/12/31/building-a-chat-server-with-node-dot-js-and-redis/";
                    window.disqus_url="http://matthewdaly.co.uk/blog/2014/12/31/building-a-chat-server-with-node-dot-js-and-redis/";
                    window.disqus_title="Building a Chat Server With Node.js and Redis";
                  </script>
                  <script type="text/javascript" src="http://disqus.com/forums/matthewdaly/embed.js"></script>
                  <noscript><a href="http://matthewdaly.disqus.com/?url=ref">View the discussion thread.</a></noscript>
              </section>
            </article>
        </div>
        <div class="col-md-4">
            <h1>Recent Posts</h1>
            <p><a href="/blog/2015/02/15/switching-to-my-own-static-site-generator/">Switching to My Own Static Site Generator</a></p>
            <p><a href="/blog/2014/12/31/building-a-chat-server-with-node-dot-js-and-redis/">Building a Chat Server With Node.js and Redis</a></p>
            <p><a href="/blog/2014/12/28/my-first-grunt-plugin/">My First Grunt Plugin</a></p>
            <p><a href="/blog/2014/11/09/building-a-url-shortener-with-node-dot-js-and-redis/">Building a URL Shortener With Node.js and Redis</a></p>
            <p><a href="/blog/2014/10/19/my-django-web-server-setup/">My Django Web Server Setup</a></p>
            <section id="github-profile">
            </section>
            <h4>My GitHub repositories</h4>
            <ul id="github-repos">
                <li>Loading repositories...</li>
            </ul>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <ul class="pager">
                <li><a href="/blog/2015/02/15/switching-to-my-own-static-site-generator/">Switching to My Own Static Site Generator</a></li>
                <li><a href="/blog/2014/12/28/my-first-grunt-plugin/">My First Grunt Plugin</a></li>
            </ul>
        </div>
    </div>

</div>

        <footer>
            <div class="container">
                <div class="col-md-12">
                    <p class="copyright">Copyright &copy; Matthew Daly 2015.</p>
                </div>
            </div>
        </footer>
        <script type="text/javascript" src="/static/js/all.min.js"></script>
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');
        </script>
    </body>
</html>
