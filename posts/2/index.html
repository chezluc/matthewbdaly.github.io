<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><link href="/favicon.ico" rel="icon"><link href="http://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet" type="text/css"><link rel="stylesheet" type="text/css" href="/static/bower_components/sass-bootstrap/dist/css/bootstrap.min.css" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><title>Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="http://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input id="search" type="search" name="q" placeholder="Search..." maxlength="200" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">15th February 2015 6:11 pm</p><h1><a href="/blog/2015/02/15/switching-to-my-own-static-site-generator/">Switching to My Own Static Site Generator</a></h1><p>As you may have seen if you’re visiting the site, I’ve finally switched over from Octopress to the static site generator I’ve been working on for the last few months. Apologies if you’re seeing lots of old posts in your RSS reader - there must have been an inconsistency between the RSS feed for this and that for Octopress.</p><p>I actually still really like Octopress, however I’m not and have never been a big fan of Ruby. Python and JavaScript are my two main go-to languages (although I do a lot of work professionally with PHP as well), so I wanted a solution in one of those languages, but I wanted something that was very similar to Octopress in every other way. I also wanted the facility to easily concatenate and minify static files as part of my deployment process to make the whole thing as lean as possible, so it made sense to build it as a Grunt plugin and create a Yeoman generator for building the boilerplate for the blog. Also, it’s always easier to work with your own code, and so using templates I wrote myself should make it quicker and easier for me to customise the blog how I want.</p><p>While deploying it did throw up a few errors that I’ve had to fix, it’s gone fairly smoothly and I’m pretty happy with it, although I will no doubt spend some time tweaking it over the next few weeks. It’s built with GitHub Pages in mind, but the fact that it’s built using Grunt should make it straightforward to switch to a different deployment method - during development I’ve actually used <code>grunt-rsync</code> to deploy to my Raspberry Pi and <code>grunt-bitbucket-pages</code> to deploy to Bitbucket in order to test it and both work absolutely fine. There are also Grunt plugins for deploying via FTP around, so if you want to check it out, then as long as you have at least some familiarity with Grunt you should be able to deploy it however you wish. The generator is meant to be only a starting point for your own site, so by all means check it out, tinker with the styling and templates, and make it your own. I will be very happy indeed if I see someone else using it in the wild.</p><p>Static site generators are generally somewhat harder to use than a CMS like WordPress, but they have many advantages:</p><ul><li>Lighter - you can quite easily host a static site with just Nginx on a Raspberry Pi</li><li>Faster - with no database or actual dynamic content on the server, just flat HTML, your site will be far quicker to load than a WordPress blog</li><li>Cheaper to host</li><li>Easy to deploy - if your workflow is very command-line based like mine is, it’s very quick and easy to get blogging</li></ul><p>If you can get away with using a static site generator rather than a database-driven blogging system, then it’s well worth doing so.</p></article><article class="post"><p class="date">31st December 2014 2:10 pm</p><h1><a href="/blog/2014/12/31/building-a-chat-server-with-node-dot-js-and-redis/">Building a Chat Server With Node.js and Redis</a></h1><p>One of the more interesting capabilities Redis offers is its support for Pub/Sub. This allows you to subscribe to a specific channel, and then react when some content is published to that channel. In this tutorial, we’ll build a very simple web-based chat system that demonstrates Redis’s Pub/Sub support in action. Chat systems are pretty much synonymous with Node.js - it’s widely considered the “Hello, World!” of Node.js. Since we already used Node with the prior Redis tutorial, then it also makes sense to stick with it for this project too.</p><h2 id="installing-node-js">Installing Node.js</h2><p>Since the last tutorial, I’ve discovered <a href="https://github.com/creationix/nvm">NVM</a>, and if you’re using any flavour of Unix, I highly recommend using it. It’s not an option if you’re using Windows, however Redis doesn’t officially support Windows anyway, so if you want to follow along on a Windows machine I’d recommend using a VM.</p><p>If you followed the URL shortener tutorial, you should already have everything you need, though I’d still recommend switching to NVM as it’s very convenient. We’ll be using Grunt again, so you’ll need to make sure you have <code>grunt-cli</code> installed with the following command:</p><pre><code class="hljs lang-bash singleline">$ npm install -g grunt-cli</code></pre><p>This assumes you used NVM to install Node - if it’s installed globally, you may need to use <code>sudo</code>.</p><h2 id="installing-dependencies">Installing dependencies</h2><p>As usual with a Node.js project, our first step is to create our <code>package.json</code> file:</p><pre><code class="hljs lang-bash singleline">$ npm init</code></pre><p>Answer the questions so you end up with something like this (or just paste this into <code>package.json</code> and amend it as you see fit):</p><pre><code class="hljs lang-json"><span class="linenos">1</span>{
<span class="linenos">2</span>  "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"babblr"</span></span>,
<span class="linenos">3</span>  "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"1.0.0"</span></span>,
<span class="linenos">4</span>  "<span class="hljs-attribute">description</span>": <span class="hljs-value"><span class="hljs-string">"Chat client"</span></span>,
<span class="linenos">5</span>  "<span class="hljs-attribute">main</span>": <span class="hljs-value"><span class="hljs-string">"index.js"</span></span>,
<span class="linenos">6</span>  "<span class="hljs-attribute">scripts</span>": <span class="hljs-value">{
<span class="linenos">7</span>    "<span class="hljs-attribute">test</span>": <span class="hljs-value"><span class="hljs-string">"grunt test --verbose"</span>
<span class="linenos">8</span>  </span>}</span>,
<span class="linenos">9</span>  "<span class="hljs-attribute">keywords</span>": <span class="hljs-value">[
<span class="linenos">10</span>    <span class="hljs-string">"chat"</span>
<span class="linenos">11</span>  ]</span>,
<span class="linenos">12</span>  "<span class="hljs-attribute">author</span>": <span class="hljs-value"><span class="hljs-string">"Matthew Daly &lt;matthew@matthewdaly.co.uk&gt; (http://matthewdaly.co.uk/)"</span></span>,
<span class="linenos">13</span>  "<span class="hljs-attribute">license</span>": <span class="hljs-value"><span class="hljs-string">"GPLv2"</span>
<span class="linenos">14</span></span>}</code></pre><p>Now let’s install our dependencies:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ npm install express hbs redis hiredis socket.io socket.io-client --save
<span class="linenos">2</span>$ npm install chai grunt grunt-contrib-jshint grunt-coveralls grunt-mocha-istanbul istanbul mocha request --save-dev</code></pre><p>These two commands will install our dependencies.</p><p>Now, if you followed on with the URL shortener tutorial, you’ll notice that we aren’t using Jade - instead we’re going to use Handlebars. Jade is quite a nice templating system, but I find it gets in the way for larger projects - you spend too much time looking up the syntax for things you already know in HTML. Handlebars is closer to HTML so we will use that. We’ll also use Socket.IO extensively on this project.</p><h2 id="support-files">Support files</h2><p>As before, we’ll also use Mocha for our unit tests and Istanbul to generate coverage stats. We’ll need a Grunt configuration for that, so here it is:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(grunt)</span> </span>{
<span class="linenos">2</span><span class="hljs-pi">    'use strict'</span>;
<span class="linenos">3</span>
<span class="linenos">4</span>    grunt.initConfig({
<span class="linenos">5</span>        jshint: {
<span class="linenos">6</span>            all: [
<span class="linenos">7</span>                <span class="hljs-string">'test/*.js'</span>,
<span class="linenos">8</span>                <span class="hljs-string">'index.js'</span>
<span class="linenos">9</span>            ]
<span class="linenos">10</span>        },
<span class="linenos">11</span>        mocha_istanbul: {
<span class="linenos">12</span>            coverage: {
<span class="linenos">13</span>                src: <span class="hljs-string">'test'</span>, <span class="hljs-comment">// the folder, not the files,</span>
<span class="linenos">14</span>                options: {
<span class="linenos">15</span>                    mask: <span class="hljs-string">'*.js'</span>,
<span class="linenos">16</span>                    reportFormats: [<span class="hljs-string">'cobertura'</span>, <span class="hljs-string">'html'</span>, <span class="hljs-string">'lcovonly'</span>]
<span class="linenos">17</span>                }
<span class="linenos">18</span>            }
<span class="linenos">19</span>        },
<span class="linenos">20</span>        coveralls: {
<span class="linenos">21</span>            options: {
<span class="linenos">22</span>                src: <span class="hljs-string">'coverage/lcov.info'</span>,
<span class="linenos">23</span>                force: <span class="hljs-literal">false</span>
<span class="linenos">24</span>            },
<span class="linenos">25</span>            app: {
<span class="linenos">26</span>                src: <span class="hljs-string">'coverage/lcov.info'</span>
<span class="linenos">27</span>            }
<span class="linenos">28</span>        }
<span class="linenos">29</span>    });
<span class="linenos">30</span>
<span class="linenos">31</span>    <span class="hljs-comment">// Load tasks</span>
<span class="linenos">32</span>    grunt.loadNpmTasks(<span class="hljs-string">'grunt-contrib-jshint'</span>);
<span class="linenos">33</span>    grunt.loadNpmTasks(<span class="hljs-string">'grunt-coveralls'</span>);
<span class="linenos">34</span>    grunt.loadNpmTasks(<span class="hljs-string">'grunt-mocha-istanbul'</span>);
<span class="linenos">35</span>
<span class="linenos">36</span>    <span class="hljs-comment">// Register tasks</span>
<span class="linenos">37</span>    grunt.registerTask(<span class="hljs-string">'test'</span>, [<span class="hljs-string">'jshint'</span>, <span class="hljs-string">'mocha_istanbul:coverage'</span>, <span class="hljs-string">'coveralls'</span>]);
<span class="linenos">38</span>};</code></pre><p>We also need a <code>.bowerrc</code>:</p><pre><code class="hljs lang-json"><span class="linenos">1</span>{
<span class="linenos">2</span>    "<span class="hljs-attribute">directory</span>": <span class="hljs-value"><span class="hljs-string">"static/bower_components"</span>
<span class="linenos">3</span></span>}</code></pre><p>And a <code>bower.json</code>:</p><pre><code class="hljs lang-json"><span class="linenos">1</span>{
<span class="linenos">2</span>  "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"babblr"</span></span>,
<span class="linenos">3</span>  "<span class="hljs-attribute">main</span>": <span class="hljs-value"><span class="hljs-string">"index.js"</span></span>,
<span class="linenos">4</span>  "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"1.0.0"</span></span>,
<span class="linenos">5</span>  "<span class="hljs-attribute">authors</span>": <span class="hljs-value">[
<span class="linenos">6</span>    <span class="hljs-string">"Matthew Daly &lt;matthewbdaly@gmail.com&gt;"</span>
<span class="linenos">7</span>  ]</span>,
<span class="linenos">8</span>  "<span class="hljs-attribute">description</span>": <span class="hljs-value"><span class="hljs-string">"A simple chat server"</span></span>,
<span class="linenos">9</span>  "<span class="hljs-attribute">moduleType</span>": <span class="hljs-value">[
<span class="linenos">10</span>    <span class="hljs-string">"node"</span>
<span class="linenos">11</span>  ]</span>,
<span class="linenos">12</span>  "<span class="hljs-attribute">keywords</span>": <span class="hljs-value">[
<span class="linenos">13</span>    <span class="hljs-string">"chat"</span>
<span class="linenos">14</span>  ]</span>,
<span class="linenos">15</span>  "<span class="hljs-attribute">license</span>": <span class="hljs-value"><span class="hljs-string">"GPLv2"</span></span>,
<span class="linenos">16</span>  "<span class="hljs-attribute">homepage</span>": <span class="hljs-value"><span class="hljs-string">"http://matthewdaly.co.uk"</span></span>,
<span class="linenos">17</span>  "<span class="hljs-attribute">private</span>": <span class="hljs-value"><span class="hljs-literal">true</span></span>,
<span class="linenos">18</span>  "<span class="hljs-attribute">ignore</span>": <span class="hljs-value">[
<span class="linenos">19</span>    <span class="hljs-string">"**/.*"</span>,
<span class="linenos">20</span>    <span class="hljs-string">"node_modules"</span>,
<span class="linenos">21</span>    <span class="hljs-string">"bower_components"</span>,
<span class="linenos">22</span>    <span class="hljs-string">"test"</span>,
<span class="linenos">23</span>    <span class="hljs-string">"tests"</span>
<span class="linenos">24</span>  ]</span>,
<span class="linenos">25</span>  "<span class="hljs-attribute">dependencies</span>": <span class="hljs-value">{
<span class="linenos">26</span>    "<span class="hljs-attribute">html5-boilerplate</span>": <span class="hljs-value"><span class="hljs-string">"~4.3.0"</span></span>,
<span class="linenos">27</span>    "<span class="hljs-attribute">jquery</span>": <span class="hljs-value"><span class="hljs-string">"~2.1.1"</span></span>,
<span class="linenos">28</span>    "<span class="hljs-attribute">bootstrap</span>": <span class="hljs-value"><span class="hljs-string">"~3.3.1"</span>
<span class="linenos">29</span>  </span>}
<span class="linenos">30</span></span>}</code></pre><p>Then install the Bower dependencies:</p><pre><code class="hljs lang-bash singleline">$ bower install</code></pre><p>We also need a <code>Procfile</code> so we can run it on Heroku:</p><pre><code class="hljs lang-bash singleline">web: node index.js</code></pre><p>Now, let’s create the main file:</p><pre><code class="hljs lang-bash singleline">$ touch index.js</code></pre><p>And our test file:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ mkdir <span class="hljs-built_in">test</span>
<span class="linenos">2</span>$ touch <span class="hljs-built_in">test</span>/test.js</code></pre><h2 id="implementing-the-chat-server">Implementing the chat server</h2><p>Next, let’s implement our first test. First of all, we’ll verify that the index route works:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-comment">/*jslint node: true */</span>
<span class="linenos">2</span><span class="hljs-comment">/*global describe: false, before: false, after: false, it: false */</span>
<span class="linenos">3</span><span class="hljs-pi">"use strict"</span>;
<span class="linenos">4</span>
<span class="linenos">5</span><span class="hljs-comment">// Declare the variables used</span>
<span class="linenos">6</span><span class="hljs-keyword">var</span> expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).expect,
<span class="linenos">7</span>    request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>),
<span class="linenos">8</span>    server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../index'</span>),
<span class="linenos">9</span>    redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>),
<span class="linenos">10</span>    io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io-client'</span>),
<span class="linenos">11</span>    client;
<span class="linenos">12</span>client = redis.createClient();
<span class="linenos">13</span>
<span class="linenos">14</span><span class="hljs-comment">// Server tasks</span>
<span class="linenos">15</span>describe(<span class="hljs-string">'server'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">16</span>
<span class="linenos">17</span>    <span class="hljs-comment">// Beforehand, start the server</span>
<span class="linenos">18</span>    before(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">19</span>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Starting the server'</span>);
<span class="linenos">20</span>        done();
<span class="linenos">21</span>    });
<span class="linenos">22</span>
<span class="linenos">23</span>    <span class="hljs-comment">// Afterwards, stop the server and empty the database</span>
<span class="linenos">24</span>    after(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">25</span>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Stopping the server'</span>);
<span class="linenos">26</span>        client.flushdb();
<span class="linenos">27</span>        done();
<span class="linenos">28</span>    });
<span class="linenos">29</span>
<span class="linenos">30</span>    <span class="hljs-comment">// Test the index route</span>
<span class="linenos">31</span>    describe(<span class="hljs-string">'Test the index route'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">32</span>        it(<span class="hljs-string">'should return a page with the title Babblr'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">33</span>            request.get({ url: <span class="hljs-string">'http://localhost:5000/'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, response, body)</span> </span>{
<span class="linenos">34</span>                expect(body).to.include(<span class="hljs-string">'Babblr'</span>);
<span class="linenos">35</span>                expect(response.statusCode).to.equal(<span class="hljs-number">200</span>);
<span class="linenos">36</span>                expect(response.headers[<span class="hljs-string">'content-type'</span>]).to.equal(<span class="hljs-string">'text/html; charset=utf-8'</span>);
<span class="linenos">37</span>                done();
<span class="linenos">38</span>            });
<span class="linenos">39</span>        });
<span class="linenos">40</span>    });
<span class="linenos">41</span>});</code></pre><p>Note that this is very similar to the first test for the URL shortener, because it’s doing basically the same thing.</p><p>Now, run the test and make sure it fails:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>
<span class="linenos">7</span>
<span class="linenos">8</span>  server
<span class="linenos">9</span>Starting the server
<span class="linenos">10</span>    Test the index route
<span class="linenos">11</span>      <span class="hljs-number">1</span>) should <span class="hljs-built_in">return</span> a page with the title Babblr
<span class="linenos">12</span>Stopping the server
<span class="linenos">13</span>
<span class="linenos">14</span>
<span class="linenos">15</span>  <span class="hljs-number">0</span> passing (<span class="hljs-number">873</span>ms)
<span class="linenos">16</span>  <span class="hljs-number">1</span> failing
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="hljs-number">1</span>) server Test the index route should <span class="hljs-built_in">return</span> a page with the title Babblr:
<span class="linenos">19</span>     Uncaught AssertionError: expected undefined to include <span class="hljs-string">'Babblr'</span>
<span class="linenos">20</span>      at Request._callback (/Users/matthewdaly/Projects/babblr/<span class="hljs-built_in">test</span>/test.js:<span class="hljs-number">34</span>:<span class="hljs-number">33</span>)
<span class="linenos">21</span>      at self.callback (/Users/matthewdaly/Projects/babblr/node_modules/request/request.js:<span class="hljs-number">373</span>:<span class="hljs-number">22</span>)
<span class="linenos">22</span>      at Request.emit (events.js:<span class="hljs-number">95</span>:<span class="hljs-number">17</span>)
<span class="linenos">23</span>      at Request.onRequestError (/Users/matthewdaly/Projects/babblr/node_modules/request/request.js:<span class="hljs-number">971</span>:<span class="hljs-number">8</span>)
<span class="linenos">24</span>      at ClientRequest.emit (events.js:<span class="hljs-number">95</span>:<span class="hljs-number">17</span>)
<span class="linenos">25</span>      at Socket.socketErrorListener (http.js:<span class="hljs-number">1552</span>:<span class="hljs-number">9</span>)
<span class="linenos">26</span>      at Socket.emit (events.js:<span class="hljs-number">95</span>:<span class="hljs-number">17</span>)
<span class="linenos">27</span>      at net.js:<span class="hljs-number">441</span>:<span class="hljs-number">14</span>
<span class="linenos">28</span>      at process._tickCallback (node.js:<span class="hljs-number">442</span>:<span class="hljs-number">13</span>)
<span class="linenos">29</span>
<span class="linenos">30</span>
<span class="linenos">31</span>
<span class="linenos">32</span>=============================================================================
<span class="linenos">33</span>Writing coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]
<span class="linenos">34</span>Writing coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]
<span class="linenos">35</span>=============================================================================
<span class="linenos">36</span>
<span class="linenos">37</span>=============================== Coverage summary ===============================
<span class="linenos">38</span>Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
<span class="linenos">39</span>Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
<span class="linenos">40</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
<span class="linenos">41</span>Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
<span class="linenos">42</span>================================================================================
<span class="linenos">43</span>&gt;&gt;
<span class="linenos">44</span>Warning: Task <span class="hljs-string">"mocha_istanbul:coverage"</span> failed. Use --force to continue.
<span class="linenos">45</span>
<span class="linenos">46</span>Aborted due to warnings.</code></pre><p>With that confirmed, we can start writing code to make the test pass:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-comment">/*jslint node: true */</span>
<span class="linenos">2</span><span class="hljs-pi">'use strict'</span>;
<span class="linenos">3</span>
<span class="linenos">4</span><span class="hljs-comment">// Declare variables used</span>
<span class="linenos">5</span><span class="hljs-keyword">var</span> app, base_url, client, express, hbs, io, port, rtg, subscribe;
<span class="linenos">6</span>
<span class="linenos">7</span><span class="hljs-comment">// Define values</span>
<span class="linenos">8</span>express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="linenos">9</span>app = express();
<span class="linenos">10</span>port = process.env.PORT || <span class="hljs-number">5000</span>;
<span class="linenos">11</span>base_url = process.env.BASE_URL || <span class="hljs-string">'http://localhost:5000'</span>;
<span class="linenos">12</span>hbs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>);
<span class="linenos">13</span>
<span class="linenos">14</span><span class="hljs-comment">// Set up connection to Redis</span>
<span class="linenos">15</span><span class="hljs-comment">/* istanbul ignore if */</span>
<span class="linenos">16</span><span class="hljs-keyword">if</span> (process.env.REDISTOGO_URL) {
<span class="linenos">17</span>    rtg  = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>).parse(process.env.REDISTOGO_URL);
<span class="linenos">18</span>    client = <span class="hljs-built_in">require</span>(<span class="hljs-string">"redis"</span>).createClient(rtg.port, rtg.hostname);
<span class="linenos">19</span>    subscribe = <span class="hljs-built_in">require</span>(<span class="hljs-string">"redis"</span>).createClient(rtg.port, rtg.hostname);
<span class="linenos">20</span>    client.auth(rtg.auth.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">1</span>]);
<span class="linenos">21</span>    subscribe.auth(rtg.auth.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">1</span>]);
<span class="linenos">22</span>} <span class="hljs-keyword">else</span> {
<span class="linenos">23</span>    client = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();
<span class="linenos">24</span>    subscribe = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();
<span class="linenos">25</span>}
<span class="linenos">26</span>
<span class="linenos">27</span><span class="hljs-comment">// Set up templating</span>
<span class="linenos">28</span>app.set(<span class="hljs-string">'views'</span>, __dirname + <span class="hljs-string">'/views'</span>);
<span class="linenos">29</span>app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">"hbs"</span>);
<span class="linenos">30</span>app.engine(<span class="hljs-string">'hbs'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'hbs'</span>).__express);
<span class="linenos">31</span>
<span class="linenos">32</span><span class="hljs-comment">// Register partials</span>
<span class="linenos">33</span>hbs.registerPartials(__dirname + <span class="hljs-string">'/views/partials'</span>);
<span class="linenos">34</span>
<span class="linenos">35</span><span class="hljs-comment">// Set URL</span>
<span class="linenos">36</span>app.set(<span class="hljs-string">'base_url'</span>, base_url);
<span class="linenos">37</span>
<span class="linenos">38</span><span class="hljs-comment">// Define index route</span>
<span class="linenos">39</span>app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> </span>{
<span class="linenos">40</span>    res.render(<span class="hljs-string">'index'</span>);
<span class="linenos">41</span>});
<span class="linenos">42</span>
<span class="linenos">43</span><span class="hljs-comment">// Serve static files</span>
<span class="linenos">44</span>app.use(express.static(__dirname + <span class="hljs-string">'/static'</span>));
<span class="linenos">45</span>
<span class="linenos">46</span><span class="hljs-comment">// Listen</span>
<span class="linenos">47</span>io = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>)({
<span class="linenos">48</span>}).listen(app.listen(port));
<span class="linenos">49</span><span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Listening on port "</span> + port);</code></pre><p>If you compare this to the code for the URL shortener, you’ll notice a few fairly substantial differences. For one thing, we set up two Redis connections, not one - that’s because we need to do so when using Pub/Sub with Redis. You’ll also notice that we register Handlebars (<code>hbs</code>) rather than Jade, and define not just a directory for views, but another directory inside it for partials. Finally, setting it up to listen at the end is a bit more involved because we’ll be using Socket.IO.</p><p>Now, you can run your tests again at this point, but they won’t pass because we haven’t created our views. So let’s do that. Create the directory <code>views</code> and the subdirectory <code>partials</code> inside it. Then add the following content to <code>views/index.hbs</code>:</p><pre><code class="hljs lang-hbs"><span class="linenos">1</span><span class="xml"></span><span class="hljs-expression">{{&gt; <span class="hljs-variable">header</span> }}</span><span class="xml">
<span class="linenos">2</span>        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span>
<span class="linenos">3</span>            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"row"</span>&gt;</span>
<span class="linenos">4</span>                <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-md-8"</span>&gt;</span>
<span class="linenos">5</span>                    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"conversation"</span>&gt;</span>
<span class="linenos">6</span>                    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="linenos">7</span>                <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="linenos">8</span>                <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"col-md-4"</span>&gt;</span>
<span class="linenos">9</span>                    <span class="hljs-tag">&lt;<span class="hljs-title">form</span>&gt;</span>
<span class="linenos">10</span>                        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-group"</span>&gt;</span>
<span class="linenos">11</span>                            <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"message"</span>&gt;</span>Message<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
<span class="linenos">12</span>                            <span class="hljs-tag">&lt;<span class="hljs-title">textarea</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-control"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"message"</span> <span class="hljs-attribute">rows</span>=<span class="hljs-value">"20"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">textarea</span>&gt;</span>
<span class="linenos">13</span>                            <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"submitbutton"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"btn btn-primary form-control"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="linenos">14</span>                        <span class="hljs-tag">&lt;<span class="hljs-title">div</span>&gt;</span>
<span class="linenos">15</span>                    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
<span class="linenos">16</span>                <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="linenos">17</span>            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="linenos">18</span>        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="linenos">19</span></span><span class="hljs-expression">{{&gt; <span class="hljs-variable">footer</span> }}</span><span class="xml"></span></code></pre><p>Add this to <code>views/partials/header.hbs</code>:</p><pre><code class="hljs lang-hbs"><span class="linenos">1</span><span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="linenos">2</span><span class="hljs-comment">&lt;!--[if lt IE 7]&gt;      &lt;html class="no-js lt-ie9 lt-ie8 lt-ie7"&gt; &lt;![endif]--&gt;</span>
<span class="linenos">3</span><span class="hljs-comment">&lt;!--[if IE 7]&gt;         &lt;html class="no-js lt-ie9 lt-ie8"&gt; &lt;![endif]--&gt;</span>
<span class="linenos">4</span><span class="hljs-comment">&lt;!--[if IE 8]&gt;         &lt;html class="no-js lt-ie9"&gt; &lt;![endif]--&gt;</span>
<span class="linenos">5</span><span class="hljs-comment">&lt;!--[if gt IE 8]&gt;&lt;!--&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">html</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"no-js"</span>&gt;</span> <span class="hljs-comment">&lt;!--&lt;![endif]--&gt;</span>
<span class="linenos">6</span>    <span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
<span class="linenos">7</span>        <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span>&gt;</span>
<span class="linenos">8</span>        <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">http-equiv</span>=<span class="hljs-value">"X-UA-Compatible"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"IE=edge"</span>&gt;</span>
<span class="linenos">9</span>        <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>Babblr<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
<span class="linenos">10</span>        <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"description"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">""</span>&gt;</span>
<span class="linenos">11</span>        <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"viewport"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"width=device-width, initial-scale=1"</span>&gt;</span>
<span class="linenos">12</span>
<span class="linenos">13</span>        <span class="hljs-comment">&lt;!-- Place favicon.ico and apple-touch-icon.png in the root directory --&gt;</span>
<span class="linenos">14</span>
<span class="linenos">15</span>        <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"/bower_components/bootstrap/dist/css/bootstrap.min.css"</span>&gt;</span>
<span class="linenos">16</span>        <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"/bower_components/bootstrap/dist/css/bootstrap-theme.min.css"</span>&gt;</span>
<span class="linenos">17</span>        <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"/css/style.css"</span>&gt;</span>
<span class="linenos">18</span>    <span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="linenos">19</span>    <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
<span class="linenos">20</span>        <span class="hljs-comment">&lt;!--[if lt IE 7]&gt;
<span class="linenos">21</span>            &lt;p class="browsehappy"&gt;You are using an &lt;strong&gt;outdated&lt;/strong&gt; browser. Please &lt;a href="http://browsehappy.com/"&gt;upgrade your browser&lt;/a&gt; to improve your experience.&lt;/p&gt;
<span class="linenos">22</span>        &lt;![endif]--&gt;</span>
<span class="linenos">23</span>        <span class="hljs-tag">&lt;<span class="hljs-title">nav</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar navbar-inverse navbar-static-top"</span> <span class="hljs-attribute">role</span>=<span class="hljs-value">"navigation"</span>&gt;</span>
<span class="linenos">24</span>            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span>
<span class="linenos">25</span>                <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-header"</span>&gt;</span>
<span class="linenos">26</span>                    <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"navbar-brand"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"#"</span>&gt;</span>Babblr<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="linenos">27</span>                <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="linenos">28</span>            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="linenos">29</span>        <span class="hljs-tag">&lt;/<span class="hljs-title">nav</span>&gt;</span></code></pre><p>And add this to <code>views/partials/footer.hbs</code>:</p><pre><code class="hljs lang-hbs"><span class="linenos">1</span>
<span class="linenos">2</span>        <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"/bower_components/jquery/dist/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="linenos">3</span>        <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"/bower_components/bootstrap/dist/js/bootstrap.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="linenos">4</span>        <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"/socket.io/socket.io.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="linenos">5</span>        <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"/js/main.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="linenos">6</span>
<span class="linenos">7</span>    <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="linenos">8</span><span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre><p>You’ll also want to create placeholder CSS and JavaScript files:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ mkdir static/js
<span class="linenos">2</span>$ mkdir static/css
<span class="linenos">3</span>$ touch static/js/main.js
<span class="linenos">4</span>$ touch static/css/style.css</code></pre><p>The test should now pass:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>Listening on port <span class="hljs-number">5000</span>
<span class="linenos">7</span>
<span class="linenos">8</span>
<span class="linenos">9</span>  server
<span class="linenos">10</span>Starting the server
<span class="linenos">11</span>    Test the index route
<span class="linenos">12</span>      ✓ should <span class="hljs-built_in">return</span> a page with the title Babblr (<span class="hljs-number">41</span>ms)
<span class="linenos">13</span>Stopping the server
<span class="linenos">14</span>
<span class="linenos">15</span>
<span class="linenos">16</span>  <span class="hljs-number">1</span> passing (<span class="hljs-number">54</span>ms)
<span class="linenos">17</span>
<span class="linenos">18</span>=============================================================================
<span class="linenos">19</span>Writing coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]
<span class="linenos">20</span>Writing coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]
<span class="linenos">21</span>=============================================================================
<span class="linenos">22</span>
<span class="linenos">23</span>=============================== Coverage summary ===============================
<span class="linenos">24</span>Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">24</span>/<span class="hljs-number">24</span> ), <span class="hljs-number">5</span> ignored
<span class="linenos">25</span>Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">6</span>/<span class="hljs-number">6</span> ), <span class="hljs-number">1</span> ignored
<span class="linenos">26</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">1</span>/<span class="hljs-number">1</span> )
<span class="linenos">27</span>Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">24</span>/<span class="hljs-number">24</span> )
<span class="linenos">28</span>================================================================================
<span class="linenos">29</span>&gt;&gt; Done. Check coverage folder.
<span class="linenos">30</span>
<span class="linenos">31</span>Running <span class="hljs-string">"coveralls:app"</span> (coveralls) task
<span class="linenos">32</span>&gt;&gt; Failed to submit <span class="hljs-string">'coverage/lcov.info'</span> to coveralls: Bad response: <span class="hljs-number">422</span> {<span class="hljs-string">"message"</span>:<span class="hljs-string">"Couldn't find a repository matching this job."</span>,<span class="hljs-string">"error"</span>:<span class="hljs-literal">true</span>}
<span class="linenos">33</span>&gt;&gt; Failed to submit coverage results to coveralls
<span class="linenos">34</span>Warning: Task <span class="hljs-string">"coveralls:app"</span> failed. Use --force to continue.
<span class="linenos">35</span>
<span class="linenos">36</span>Aborted due to warnings.</code></pre><p>Don’t worry about the coveralls task failing, as that only needs to pass when it runs on Travis CI.</p><p>So we now have our main route in place. The next step is to actually implement the chat functionality. Add this code to the test file:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span>
<span class="linenos">2</span>    <span class="hljs-comment">// Test sending a message</span>
<span class="linenos">3</span>    describe(<span class="hljs-string">'Test sending a message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">4</span>        it(<span class="hljs-string">"should return 'Message received'"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">5</span>            <span class="hljs-comment">// Connect to server</span>
<span class="linenos">6</span>            <span class="hljs-keyword">var</span> socket = io.connect(<span class="hljs-string">'http://localhost:5000'</span>, {
<span class="linenos">7</span>                <span class="hljs-string">'reconnection delay'</span> : <span class="hljs-number">0</span>,
<span class="linenos">8</span>                <span class="hljs-string">'reopen delay'</span> : <span class="hljs-number">0</span>,
<span class="linenos">9</span>                <span class="hljs-string">'force new connection'</span> : <span class="hljs-literal">true</span>
<span class="linenos">10</span>            });
<span class="linenos">11</span>
<span class="linenos">12</span>            <span class="hljs-comment">// Handle the message being received</span>
<span class="linenos">13</span>            socket.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
<span class="linenos">14</span>                expect(data).to.include(<span class="hljs-string">'Message received'</span>);
<span class="linenos">15</span>                socket.disconnect();
<span class="linenos">16</span>                done();
<span class="linenos">17</span>            });
<span class="linenos">18</span>
<span class="linenos">19</span>            <span class="hljs-comment">// Send the message</span>
<span class="linenos">20</span>            socket.emit(<span class="hljs-string">'send'</span>, { message: <span class="hljs-string">'Message received'</span> });
<span class="linenos">21</span>        });
<span class="linenos">22</span>    });</code></pre><p>This code should be fairly straightforward to understand. First, we connect to the server. Then, we set up a handler to verify the content of the message when it gets sent. Finally, we send the message. Let’s run the tests to make sure we get the expected result:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>Listening on port <span class="hljs-number">5000</span>
<span class="linenos">7</span>
<span class="linenos">8</span>
<span class="linenos">9</span>  server
<span class="linenos">10</span>Starting the server
<span class="linenos">11</span>    Test the index route
<span class="linenos">12</span>      ✓ should <span class="hljs-built_in">return</span> a page with the title Babblr (<span class="hljs-number">337</span>ms)
<span class="linenos">13</span>    Test sending a message
<span class="linenos">14</span>      <span class="hljs-number">1</span>) should <span class="hljs-built_in">return</span> <span class="hljs-string">'Message received'</span>
<span class="linenos">15</span>Stopping the server
<span class="linenos">16</span>
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="hljs-number">1</span> passing (<span class="hljs-number">2</span>s)
<span class="linenos">19</span>  <span class="hljs-number">1</span> failing
<span class="linenos">20</span>
<span class="linenos">21</span>  <span class="hljs-number">1</span>) server Test sending a message should <span class="hljs-built_in">return</span> <span class="hljs-string">'Message received'</span>:
<span class="linenos">22</span>     Error: timeout of <span class="hljs-number">2000</span>ms exceeded
<span class="linenos">23</span>      at null.&lt;anonymous&gt; (/Users/matthewdaly/Projects/babblr/node_modules/mocha/lib/runnable.js:<span class="hljs-number">159</span>:<span class="hljs-number">19</span>)
<span class="linenos">24</span>      at Timer.listOnTimeout [as ontimeout] (timers.js:<span class="hljs-number">112</span>:<span class="hljs-number">15</span>)
<span class="linenos">25</span>
<span class="linenos">26</span>
<span class="linenos">27</span>
<span class="linenos">28</span>=============================================================================
<span class="linenos">29</span>Writing coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]
<span class="linenos">30</span>Writing coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]
<span class="linenos">31</span>=============================================================================
<span class="linenos">32</span>
<span class="linenos">33</span>=============================== Coverage summary ===============================
<span class="linenos">34</span>Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">24</span>/<span class="hljs-number">24</span> ), <span class="hljs-number">5</span> ignored
<span class="linenos">35</span>Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">6</span>/<span class="hljs-number">6</span> ), <span class="hljs-number">1</span> ignored
<span class="linenos">36</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">1</span>/<span class="hljs-number">1</span> )
<span class="linenos">37</span>Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">24</span>/<span class="hljs-number">24</span> )
<span class="linenos">38</span>================================================================================
<span class="linenos">39</span>&gt;&gt;
<span class="linenos">40</span>Warning: Task <span class="hljs-string">"mocha_istanbul:coverage"</span> failed. Use --force to continue.
<span class="linenos">41</span>
<span class="linenos">42</span>Aborted due to warnings.</code></pre><p>Now, let’s implement this functionality. Add this at the end of <code>index.js</code>:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-comment">// Handle new messages</span>
<span class="linenos">2</span>io.sockets.on(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(socket)</span> </span>{
<span class="linenos">3</span>    <span class="hljs-comment">// Subscribe to the Redis channel</span>
<span class="linenos">4</span>    subscribe.subscribe(<span class="hljs-string">'ChatChannel'</span>);
<span class="linenos">5</span>
<span class="linenos">6</span>    <span class="hljs-comment">// Handle incoming messages</span>
<span class="linenos">7</span>    socket.on(<span class="hljs-string">'send'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
<span class="linenos">8</span>        <span class="hljs-comment">// Publish it</span>
<span class="linenos">9</span>        client.publish(<span class="hljs-string">'ChatChannel'</span>, data.message);
<span class="linenos">10</span>    });
<span class="linenos">11</span>
<span class="linenos">12</span>    <span class="hljs-comment">// Handle receiving messages</span>
<span class="linenos">13</span>    <span class="hljs-keyword">var</span> callback = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(channel, data)</span> </span>{
<span class="linenos">14</span>        socket.emit(<span class="hljs-string">'message'</span>, data);
<span class="linenos">15</span>    };
<span class="linenos">16</span>    subscribe.on(<span class="hljs-string">'message'</span>, callback);
<span class="linenos">17</span>
<span class="linenos">18</span>    <span class="hljs-comment">// Handle disconnect</span>
<span class="linenos">19</span>    socket.on(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">20</span>        subscribe.removeListener(<span class="hljs-string">'message'</span>, callback);
<span class="linenos">21</span>    });
<span class="linenos">22</span>});</code></pre><p>We’ll go through this. First, we create a callback for when a new connection is received. Inside the callback, we then subscribe to a Pub/Sub channel in Redis called <code>ChatChannel</code>.</p><p>Then, we define another callback so that on a <code>send</code> event from Socket.IO, we get the message and publish it to <code>ChatChannel</code>. After that, we define another callback to handle receiving messages, and set it to run when a new message is published to <code>ChatChannel</code>. Finally, we set up a callback to handle removing the listener when a user disconnects.</p><p>Note the two different connections to Redis - <code>client</code> and <code>subscribe</code>. As mentioned earlier, you need to use two connections to Redis when using Pub/Sub. This is because a client subscribed to one or more channels should not issue commands, so we use <code>subscribe</code> as a dedicated connection to handle subscriptions, and use <code>client</code> to publish new messages.</p><p>We’ll also need a bit of client-side JavaScript to handle sending and receiving messages. Amend <code>main.js</code> as follows:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span>$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">2</span><span class="hljs-pi">    'use strict'</span>;
<span class="linenos">3</span>
<span class="linenos">4</span>    <span class="hljs-comment">// Set up the connection</span>
<span class="linenos">5</span>    <span class="hljs-keyword">var</span> field, socket, output;
<span class="linenos">6</span>    socket = io.connect(<span class="hljs-built_in">window</span>.location.href);
<span class="linenos">7</span>
<span class="linenos">8</span>    <span class="hljs-comment">// Get a reference to the input</span>
<span class="linenos">9</span>    field = $(<span class="hljs-string">'textarea#message'</span>);
<span class="linenos">10</span>
<span class="linenos">11</span>    <span class="hljs-comment">// Get a reference to the output</span>
<span class="linenos">12</span>    output = $(<span class="hljs-string">'div.conversation'</span>);
<span class="linenos">13</span>
<span class="linenos">14</span>    <span class="hljs-comment">// Handle message submit</span>
<span class="linenos">15</span>    $(<span class="hljs-string">'a#submitbutton'</span>).on(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">16</span>        <span class="hljs-comment">// Create the message</span>
<span class="linenos">17</span>        <span class="hljs-keyword">var</span> msg;
<span class="linenos">18</span>        msg = field.val();
<span class="linenos">19</span>        socket.emit(<span class="hljs-string">'send'</span>, { message: msg });
<span class="linenos">20</span>        field.val(<span class="hljs-string">''</span>);
<span class="linenos">21</span>    });
<span class="linenos">22</span>
<span class="linenos">23</span>    <span class="hljs-comment">// Handle incoming messages</span>
<span class="linenos">24</span>    socket.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
<span class="linenos">25</span>        <span class="hljs-comment">// Insert the message</span>
<span class="linenos">26</span>        output.append(<span class="hljs-string">'&lt;p&gt;Anonymous Coward : '</span> + data + <span class="hljs-string">'&lt;/p&gt;'</span>);
<span class="linenos">27</span>    });
<span class="linenos">28</span>});</code></pre><p>Here we have one callback that handles sending messages, and another that handles receiving messages. Note that every message will be preceded with Anonymous Coward - we won’t implement user names at this point (though I plan it for a future instalment).</p><p>We’ll also add a little bit of additional styling:</p><pre><code class="hljs lang-css"><span class="linenos">1</span><span class="hljs-tag">div</span><span class="hljs-class">.conversation</span> <span class="hljs-rules">{
<span class="linenos">2</span>    <span class="hljs-rule"><span class="hljs-attribute">height</span>:<span class="hljs-value"> <span class="hljs-number">500px</span></span></span>;
<span class="linenos">3</span>    <span class="hljs-rule"><span class="hljs-attribute">overflow-y</span>:<span class="hljs-value"> scroll</span></span>;
<span class="linenos">4</span>    <span class="hljs-rule"><span class="hljs-attribute">border</span>:<span class="hljs-value"> <span class="hljs-number">1px</span> solid <span class="hljs-hexcolor">#000</span></span></span>;
<span class="linenos">5</span>    <span class="hljs-rule"><span class="hljs-attribute">padding</span>:<span class="hljs-value"> <span class="hljs-number">10px</span></span></span>;
<span class="linenos">6</span>}</span></code></pre><p>Now, if you run your tests, they should pass:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>Listening on port <span class="hljs-number">5000</span>
<span class="linenos">7</span>
<span class="linenos">8</span>
<span class="linenos">9</span>  server
<span class="linenos">10</span>Starting the server
<span class="linenos">11</span>    Test the index route
<span class="linenos">12</span>      ✓ should <span class="hljs-built_in">return</span> a page with the title Babblr (<span class="hljs-number">40</span>ms)
<span class="linenos">13</span>    Test sending a message
<span class="linenos">14</span>      ✓ should <span class="hljs-built_in">return</span> <span class="hljs-string">'Message received'</span> (<span class="hljs-number">45</span>ms)
<span class="linenos">15</span>Stopping the server
<span class="linenos">16</span>
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="hljs-number">2</span> passing (<span class="hljs-number">101</span>ms)
<span class="linenos">19</span>
<span class="linenos">20</span>=============================================================================
<span class="linenos">21</span>Writing coverage object [/Users/matthewdaly/Projects/babblr/coverage/coverage.json]
<span class="linenos">22</span>Writing coverage reports at [/Users/matthewdaly/Projects/babblr/coverage]
<span class="linenos">23</span>=============================================================================
<span class="linenos">24</span>
<span class="linenos">25</span>=============================== Coverage summary ===============================
<span class="linenos">26</span>Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">33</span>/<span class="hljs-number">33</span> ), <span class="hljs-number">5</span> ignored
<span class="linenos">27</span>Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">6</span>/<span class="hljs-number">6</span> ), <span class="hljs-number">1</span> ignored
<span class="linenos">28</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">5</span>/<span class="hljs-number">5</span> )
<span class="linenos">29</span>Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">33</span>/<span class="hljs-number">33</span> )
<span class="linenos">30</span>================================================================================
<span class="linenos">31</span>&gt;&gt; Done. Check coverage folder.
<span class="linenos">32</span>
<span class="linenos">33</span>Running <span class="hljs-string">"coveralls:app"</span> (coveralls) task
<span class="linenos">34</span>&gt;&gt; Failed to submit <span class="hljs-string">'coverage/lcov.info'</span> to coveralls: Bad response: <span class="hljs-number">422</span> {<span class="hljs-string">"message"</span>:<span class="hljs-string">"Couldn't find a repository matching this job."</span>,<span class="hljs-string">"error"</span>:<span class="hljs-literal">true</span>}
<span class="linenos">35</span>&gt;&gt; Failed to submit coverage results to coveralls
<span class="linenos">36</span>Warning: Task <span class="hljs-string">"coveralls:app"</span> failed. Use --force to continue.
<span class="linenos">37</span>
<span class="linenos">38</span>Aborted due to warnings.</code></pre><p>If you now run the following command:</p><pre><code class="hljs lang-bash singleline">$ node index.js</code></pre><p>Then visit <code>http://localhost:5000</code>, you should be able to create new messages. If you then open it up in a second tab, you can see messages added in one tab appear in another. Deploying to Heroku using Redis To Go will be straightforward, and you can then access it from multiple devices and see new chat messages appear in real time.</p><h2 id="wrapping-up">Wrapping up</h2><p>This illustrates just how straightforward it is to use Redis’s Pub/Sub capability. The chat system is still quite limited, so in a future instalment we’ll develop it further. You can get the source code from the <a href="https://github.com/matthewbdaly/babblr">Github repository</a> - just switch to the <code>lesson-1</code> tag.</p></article><article class="post"><p class="date">28th December 2014 5:04 pm</p><h1><a href="/blog/2014/12/28/my-first-grunt-plugin/">My First Grunt Plugin</a></h1><p>A while back, I mentioned that I’d written a Yeoman generator for creating a flat HTML blog, called <a href="https://github.com/matthewbdaly/generator-simple-static-blog">generator-simple-static-blog</a>. For this, I’d used the first Grunt plugin I could find for the purpose, which was <a href="https://github.com/testdouble/grunt-markdown-blog">grunt-markdown-blog</a>. This worked, but I wasn’t really very happy with it.</p><p>The ideal Grunt plugin I had in mind was as follows:</p><ul><li>Used Handlebars for templating</li><li>Generated posts from Markdown files</li><li>Saved files in named folders with a single <code>index.html</code> file in each one (like Octopress does) so that no file extension is visible on a page</li><li>Generated index pages, rather than just showing the latest post as the first page</li></ul><p>Unfortunately, <code>grunt-markdown-blog</code> only fulfilled the second criteria, so it was never going to be something I stuck with long-term. However, I couldn’t find anything else that would do the trick, so it looked like my only option was to write a suitable plugin myself.</p><p>I started a new Git repository a while back, but didn’t make much progress. Then, on Christmas Eve, I suddenly got the urge to start working on this again, and in a matter of a few hours I’d gotten a working Grunt plugin that ticked all of these boxes. I had to delay getting it integrated into the generator due to Christmas day, and then an unfortunate bout of flu, but I’ve now published it as <a href="https://github.com/matthewbdaly/grunt-blogbuilder">grunt-blogbuilder</a> and amended the Yeoman generator to use it instead.</p><p>I’m really pleased with the outcome, and while I’m still not yet ready to migrate over to it from Octopress, it’s a massive step forward, and building a Grunt plugin has been an interesting experience.</p></article><article class="post"><p class="date">9th November 2014 5:13 pm</p><h1><a href="/blog/2014/11/09/building-a-url-shortener-with-node-dot-js-and-redis/">Building a URL Shortener With Node.js and Redis</a></h1><p>The NoSQL movement is an exciting one for web developers. While relational databases such as MySQL are applicable to solving a wide range of problems, they aren’t the best solution for every problem. Sometimes you may find yourself dealing with a problem where an alternative data store may make more sense.</p><p>Redis is one of the data stores that have appeared as part of this movement, and is arguably one of the more generally useful ones. Since it solves different problems to a relational database, it’s not generally useful as an alternative to them - instead it is often used alongside them.</p><h2 id="what-is-redis-">What is Redis?</h2><p>Redis is described as follows on the website:</p><blockquote><p>“Redis is an open source, BSD licensed, advanced key-value cache and store. It is often referred to as a data structure server since keys can contain strings, hashes, lists, sets, sorted sets, bitmaps and hyperloglogs”.</p></blockquote><p>In other words, its core functionality is that it allows you to store a value by a key, and later retrieve that data using the key. It also allows you to set an optional expiry time for that key-value pair. It’s quite similar to Memcached in that respect, and indeed one obvious use case for Redis is as an alternative to Memcached. However, it offers a number of additional benefits - for one thing, it supports more data types, and for another, it allows you to persist your data to disk (unlike Memcached, which only retains the data in memory, meaning it’s lost on restart or if Memcached crashes). The latter means that for some very simple web applications, Redis can be used as your sole data store.</p><p>In this tutorial, we’ll build a simple URL shortener, using Redis as the sole data store. A URL shortener only really requires two fields:</p><ul><li>A string to identify the correct URL</li><li>The URL</li></ul><p>That makes Redis a good fit for this use case since all we need to do is generate an ID for each URL, then when a link is followed, look up the URL for that key, and redirect the user to it. As long as this is all our application needs to do, we can quite happily use Redis for this rather than a relational database, and it will be significantly faster than a relational database would be for this use case.</p><h2 id="getting-started">Getting started</h2><p>We’re more interested in the fundamentals of using Redis in our application than a specific language here. As JavaScript is pretty much required to be a web developer, I think it’s a fairly safe bet to use Node.js rather than PHP or Python, since that way, even if your only experience of JavaScript is client-side, you shouldn’t have too much trouble following along.</p><p>You’ll need to have Node.js installed, and I’ll leave the details of installing this to you. You’ll also need the Grunt CLI - install this globally as follows:</p><pre><code class="hljs lang-bash singleline">$ sudo npm install -g grunt-cli</code></pre><p>Finally, you’ll want to have Redis itself installed. You might also want to install hiredis, which is a faster Redis client that gets used automatically where available.</p><p>Now, let’s create our <code>package.json</code> file:</p><pre><code class="hljs lang-bash singleline">$ npm init</code></pre><p>You’ll see a number of questions. Your generated <code>package.json</code> file should look something like this:</p><pre><code class="hljs lang-json"><span class="linenos">1</span>{
<span class="linenos">2</span>  "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"url-shortener"</span></span>,
<span class="linenos">3</span>  "<span class="hljs-attribute">version</span>": <span class="hljs-value"><span class="hljs-string">"1.0.0"</span></span>,
<span class="linenos">4</span>  "<span class="hljs-attribute">description</span>": <span class="hljs-value"><span class="hljs-string">"A URL shortener"</span></span>,
<span class="linenos">5</span>  "<span class="hljs-attribute">main</span>": <span class="hljs-value"><span class="hljs-string">"index.js"</span></span>,
<span class="linenos">6</span>  "<span class="hljs-attribute">scripts</span>": <span class="hljs-value">{
<span class="linenos">7</span>    "<span class="hljs-attribute">test</span>": <span class="hljs-value"><span class="hljs-string">"grunt test"</span>
<span class="linenos">8</span>  </span>}</span>,
<span class="linenos">9</span>  "<span class="hljs-attribute">keywords</span>": <span class="hljs-value">[
<span class="linenos">10</span>    <span class="hljs-string">"URL"</span>,
<span class="linenos">11</span>    <span class="hljs-string">"shortener"</span>
<span class="linenos">12</span>  ]</span>,
<span class="linenos">13</span>  "<span class="hljs-attribute">author</span>": <span class="hljs-value"><span class="hljs-string">"Matthew Daly &lt;matthew@matthewdaly.co.uk&gt; (http://matthewdaly.co.uk/)"</span></span>,
<span class="linenos">14</span>  "<span class="hljs-attribute">license</span>": <span class="hljs-value"><span class="hljs-string">"GPLv2"</span>
<span class="linenos">15</span></span>}</code></pre><p>Note in particular that we set our test command to <code>grunt test</code>.</p><p>Next, we install our required Node.js modules. First, install, the normal dependencies:</p><pre><code class="hljs lang-bash singleline">$ npm install --save body-parser express redis hiredis jade shortid</code></pre><p>Next, install the development dependencies:</p><pre><code class="hljs lang-bash singleline">$ npm install --save-dev grunt grunt-contrib-jshint grunt-mocha-istanbul istanbul mocha chai request</code></pre><p>Now, we’re going to use Grunt to run our tests, so that we can easily lint the JavaScript and generate code coverage details. Here’s the Gruntfile:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(grunt)</span> </span>{
<span class="linenos">2</span><span class="hljs-pi">    'use strict'</span>;
<span class="linenos">3</span>
<span class="linenos">4</span>    grunt.initConfig({
<span class="linenos">5</span>        jshint: {
<span class="linenos">6</span>            all: [
<span class="linenos">7</span>                <span class="hljs-string">'test/*.js'</span>,
<span class="linenos">8</span>                <span class="hljs-string">'index.js'</span>
<span class="linenos">9</span>            ]
<span class="linenos">10</span>        },
<span class="linenos">11</span>        mocha_istanbul: {
<span class="linenos">12</span>            coverage: {
<span class="linenos">13</span>                src: <span class="hljs-string">'test'</span>, <span class="hljs-comment">// the folder, not the files,</span>
<span class="linenos">14</span>                options: {
<span class="linenos">15</span>                    mask: <span class="hljs-string">'*.js'</span>,
<span class="linenos">16</span>                    reportFormats: [<span class="hljs-string">'cobertura'</span>, <span class="hljs-string">'html'</span>]
<span class="linenos">17</span>                }
<span class="linenos">18</span>            }
<span class="linenos">19</span>        }
<span class="linenos">20</span>    });
<span class="linenos">21</span>
<span class="linenos">22</span>    <span class="hljs-comment">// Load tasks</span>
<span class="linenos">23</span>    grunt.loadNpmTasks(<span class="hljs-string">'grunt-contrib-jshint'</span>);
<span class="linenos">24</span>    grunt.loadNpmTasks(<span class="hljs-string">'grunt-mocha-istanbul'</span>);
<span class="linenos">25</span>
<span class="linenos">26</span>    <span class="hljs-comment">// Register tasks</span>
<span class="linenos">27</span>    grunt.registerTask(<span class="hljs-string">'test'</span>, [<span class="hljs-string">'jshint'</span>, <span class="hljs-string">'mocha_istanbul:coverage'</span>]);
<span class="linenos">28</span>};</code></pre><p>We’ll also create a <code>Procfile</code> in anticipation of deploying the app to Heroku:</p><pre><code class="hljs lang-bash singleline">web: node index.js</code></pre><h2 id="creating-the-views">Creating the views</h2><p>For this application we’ll be using the Express framework and the Jade templating system. We need three templates:</p><ul><li>Submission form</li><li>Output form</li><li>404 page</li></ul><p>Create the folder <code>views</code> under the application directory and add the files <code>views/index.jade</code>:</p><pre><code class="hljs lang-jade"><span class="linenos">1</span>doctype <span class="hljs-tag">html</span>
<span class="linenos">2</span><span class="hljs-function"><span class="hljs-title">html</span><span class="hljs-params">(lang=<span class="hljs-string">"en"</span>)</span></span>
<span class="linenos">3</span>    head
<span class="linenos">4</span>        title=<span class="hljs-string">"Shortbread"</span>
<span class="linenos">5</span>
<span class="linenos">6</span>    <span class="hljs-tag">body</span>
<span class="linenos">7</span>        <span class="hljs-tag">div</span><span class="hljs-class">.container</span>
<span class="linenos">8</span>            <span class="hljs-tag">div</span><span class="hljs-class">.row</span>
<span class="linenos">9</span>                <span class="hljs-tag">h1</span> Shortbread
<span class="linenos">10</span>
<span class="linenos">11</span>            <span class="hljs-tag">div</span><span class="hljs-class">.row</span>
<span class="linenos">12</span>                <span class="hljs-function"><span class="hljs-title">form</span><span class="hljs-params">(action=<span class="hljs-string">"/"</span>, method=<span class="hljs-string">"POST"</span>)</span></span>
<span class="linenos">13</span>                    <span class="hljs-function"><span class="hljs-title">input</span><span class="hljs-params">(type=<span class="hljs-string">"url"</span>, name=<span class="hljs-string">"url"</span>)</span></span>
<span class="linenos">14</span>                    <span class="hljs-function"><span class="hljs-title">input</span><span class="hljs-params">(type=<span class="hljs-string">"submit"</span>, value=<span class="hljs-string">"Submit"</span>)</span></span></code></pre><p>Also <code>views/output.jade</code>:</p><pre><code class="hljs lang-jade"><span class="linenos">1</span>doctype html
<span class="linenos">2</span>html(lang=<span class="hljs-string">"en"</span>)
<span class="linenos">3</span>    head
<span class="linenos">4</span>        title=Shortbread
<span class="linenos">5</span>
<span class="linenos">6</span>    body
<span class="linenos">7</span>        <span class="hljs-operator">div</span>.container
<span class="linenos">8</span>            <span class="hljs-operator">div</span>.row
<span class="linenos">9</span>                h1 Shortbread
<span class="linenos">10</span>                p
<span class="linenos">11</span>                    | Your shortened <span class="hljs-built_in">URL</span> is
<span class="linenos">12</span>                    <span class="hljs-operator">a</span>(href=base_url+<span class="hljs-string">'/'</span>+id) <span class="hljs-comment">#{base_url}/#{id}</span></code></pre><p>and <code>views/error.jade</code>:</p><pre><code class="hljs lang-jade"><span class="linenos">1</span>doctype <span class="hljs-tag">html</span>
<span class="linenos">2</span><span class="hljs-function"><span class="hljs-title">html</span><span class="hljs-params">(lang=<span class="hljs-string">"en"</span>)</span></span>
<span class="linenos">3</span>    head
<span class="linenos">4</span>        title=<span class="hljs-string">"Shortbread"</span>
<span class="linenos">5</span>
<span class="linenos">6</span>    <span class="hljs-tag">body</span>
<span class="linenos">7</span>        <span class="hljs-tag">div</span><span class="hljs-class">.container</span>
<span class="linenos">8</span>            <span class="hljs-tag">div</span><span class="hljs-class">.row</span>
<span class="linenos">9</span>                <span class="hljs-tag">h1</span> Shortbread
<span class="linenos">10</span>                <span class="hljs-tag">p</span> Link not found</code></pre><h2 id="writing-our-first-test">Writing our first test</h2><p>We’re going to use Mocha for our tests, together with the Chai assertion library. Create a folder called <code>test</code>, and put the following in <code>test/test.js</code>:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-comment">/*jslint node: true */</span>
<span class="linenos">2</span><span class="hljs-comment">/*global describe: false, before: false, after: false, it: false */</span>
<span class="linenos">3</span><span class="hljs-pi">"use strict"</span>;
<span class="linenos">4</span>
<span class="linenos">5</span><span class="hljs-comment">// Declare the variables used</span>
<span class="linenos">6</span><span class="hljs-keyword">var</span> expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chai'</span>).expect,
<span class="linenos">7</span>    request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>),
<span class="linenos">8</span>    server = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../index'</span>),
<span class="linenos">9</span>    redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>),
<span class="linenos">10</span>    client;
<span class="linenos">11</span>client = redis.createClient();
<span class="linenos">12</span>
<span class="linenos">13</span><span class="hljs-comment">// Server tasks</span>
<span class="linenos">14</span>describe(<span class="hljs-string">'server'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">15</span>
<span class="linenos">16</span>    <span class="hljs-comment">// Beforehand, start the server</span>
<span class="linenos">17</span>    before(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">18</span>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Starting the server'</span>);
<span class="linenos">19</span>        done();
<span class="linenos">20</span>    });
<span class="linenos">21</span>
<span class="linenos">22</span>    <span class="hljs-comment">// Afterwards, stop the server and empty the database</span>
<span class="linenos">23</span>    after(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">24</span>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Stopping the server'</span>);
<span class="linenos">25</span>        client.flushdb();
<span class="linenos">26</span>        done();
<span class="linenos">27</span>    });
<span class="linenos">28</span>
<span class="linenos">29</span>    <span class="hljs-comment">// Test the index route</span>
<span class="linenos">30</span>    describe(<span class="hljs-string">'Test the index route'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">31</span>        it(<span class="hljs-string">'should return a page with the title Shortbread'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">32</span>            request.get({ url: <span class="hljs-string">'http://localhost:5000'</span> }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, response, body)</span> </span>{
<span class="linenos">33</span>                expect(body).to.include(<span class="hljs-string">'Shortbread'</span>);
<span class="linenos">34</span>                expect(response.statusCode).to.equal(<span class="hljs-number">200</span>);
<span class="linenos">35</span>                expect(response.headers[<span class="hljs-string">'content-type'</span>]).to.equal(<span class="hljs-string">'text/html; charset=utf-8'</span>);
<span class="linenos">36</span>                done();
<span class="linenos">37</span>            });
<span class="linenos">38</span>        });
<span class="linenos">39</span>    });
<span class="linenos">40</span>});</code></pre><p>This code bears a little explanation. First, we import the required modules, as well as our <code>index.js</code> file (which we have yet to add). Then we create a callback to contain our tests.</p><p>Inside the callback, we call the <code>before()</code> and <code>after()</code> functions, which let us set up and tear down our tests. As part of the teardown process, we flush the Redis database.</p><p>Finally, we fetch our home page and verify that it returns a 200 status code and a content type of text/html, as well as including the name or our application.</p><p>We’ll need to create our <code>index.js</code> file to avoid a nasty error, but we won’t populate it just yet:</p><pre><code class="hljs lang-bash singleline">$ touch index.js</code></pre><p>Let’s run our tests:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>
<span class="linenos">7</span>
<span class="linenos">8</span>  server
<span class="linenos">9</span>Starting the server
<span class="linenos">10</span>    Test the index route
<span class="linenos">11</span>      <span class="hljs-number">1</span>) should <span class="hljs-built_in">return</span> a page with the title Shortbread
<span class="linenos">12</span>Stopping the server
<span class="linenos">13</span>
<span class="linenos">14</span>
<span class="linenos">15</span>  <span class="hljs-number">0</span> passing (<span class="hljs-number">152</span>ms)
<span class="linenos">16</span>  <span class="hljs-number">1</span> failing
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="hljs-number">1</span>) server Test the index route should <span class="hljs-built_in">return</span> a page with the title Shortbread:
<span class="linenos">19</span>     Uncaught AssertionError: expected undefined to include <span class="hljs-string">'Shortbread'</span>
<span class="linenos">20</span>      at Request._callback (/Users/matthewdaly/Projects/url-shortener/<span class="hljs-built_in">test</span>/test.js:<span class="hljs-number">33</span>:<span class="hljs-number">33</span>)
<span class="linenos">21</span>      at self.callback (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">372</span>:<span class="hljs-number">22</span>)
<span class="linenos">22</span>      at Request.emit (events.js:<span class="hljs-number">95</span>:<span class="hljs-number">17</span>)
<span class="linenos">23</span>      at Request.onRequestError (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">963</span>:<span class="hljs-number">8</span>)
<span class="linenos">24</span>      at ClientRequest.emit (events.js:<span class="hljs-number">95</span>:<span class="hljs-number">17</span>)
<span class="linenos">25</span>      at Socket.socketErrorListener (http.js:<span class="hljs-number">1551</span>:<span class="hljs-number">9</span>)
<span class="linenos">26</span>      at Socket.emit (events.js:<span class="hljs-number">95</span>:<span class="hljs-number">17</span>)
<span class="linenos">27</span>      at net.js:<span class="hljs-number">440</span>:<span class="hljs-number">14</span>
<span class="linenos">28</span>      at process._tickCallback (node.js:<span class="hljs-number">419</span>:<span class="hljs-number">13</span>)
<span class="linenos">29</span>
<span class="linenos">30</span>
<span class="linenos">31</span>
<span class="linenos">32</span>=============================================================================
<span class="linenos">33</span>Writing coverage object [/Users/matthewdaly/Projects/url-shortener/coverage/coverage.json]
<span class="linenos">34</span>Writing coverage reports at [/Users/matthewdaly/Projects/url-shortener/coverage]
<span class="linenos">35</span>=============================================================================
<span class="linenos">36</span>
<span class="linenos">37</span>=============================== Coverage summary ===============================
<span class="linenos">38</span>Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
<span class="linenos">39</span>Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
<span class="linenos">40</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
<span class="linenos">41</span>Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">0</span>/<span class="hljs-number">0</span> )
<span class="linenos">42</span>================================================================================
<span class="linenos">43</span>&gt;&gt;
<span class="linenos">44</span>Warning: Task <span class="hljs-string">"mocha_istanbul:coverage"</span> failed. Use --force to continue.
<span class="linenos">45</span>
<span class="linenos">46</span>Aborted due to warnings.</code></pre><p>Now that we have a failing test, we can start work on our app proper. Open up <code>index.js</code> and add the following code:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-comment">/*jslint node: true */</span>
<span class="linenos">2</span><span class="hljs-pi">'use strict'</span>;
<span class="linenos">3</span>
<span class="linenos">4</span><span class="hljs-comment">// Declare variables used</span>
<span class="linenos">5</span><span class="hljs-keyword">var</span> app, base_url, bodyParser, client, express, port, rtg, shortid;
<span class="linenos">6</span>
<span class="linenos">7</span><span class="hljs-comment">// Define values</span>
<span class="linenos">8</span>express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="linenos">9</span>app = express();
<span class="linenos">10</span>port = process.env.PORT || <span class="hljs-number">5000</span>;
<span class="linenos">11</span>shortid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'shortid'</span>);
<span class="linenos">12</span>bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);
<span class="linenos">13</span>base_url = process.env.BASE_URL || <span class="hljs-string">'http://localhost:5000'</span>;
<span class="linenos">14</span>
<span class="linenos">15</span><span class="hljs-comment">// Set up connection to Redis</span>
<span class="linenos">16</span><span class="hljs-keyword">if</span> (process.env.REDISTOGO_URL) {
<span class="linenos">17</span>  rtg  = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>).parse(process.env.REDISTOGO_URL);
<span class="linenos">18</span>  client = <span class="hljs-built_in">require</span>(<span class="hljs-string">"redis"</span>).createClient(rtg.port, rtg.hostname);
<span class="linenos">19</span>  client.auth(rtg.auth.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">1</span>]);
<span class="linenos">20</span>} <span class="hljs-keyword">else</span> {
<span class="linenos">21</span>  client = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();
<span class="linenos">22</span>}
<span class="linenos">23</span>
<span class="linenos">24</span><span class="hljs-comment">// Set up templating</span>
<span class="linenos">25</span>app.set(<span class="hljs-string">'views'</span>, __dirname + <span class="hljs-string">'/views'</span>);
<span class="linenos">26</span>app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">"jade"</span>);
<span class="linenos">27</span>app.engine(<span class="hljs-string">'jade'</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">'jade'</span>).__express);
<span class="linenos">28</span>
<span class="linenos">29</span><span class="hljs-comment">// Set URL</span>
<span class="linenos">30</span>app.set(<span class="hljs-string">'base_url'</span>, base_url);
<span class="linenos">31</span>
<span class="linenos">32</span><span class="hljs-comment">// Handle POST data</span>
<span class="linenos">33</span>app.use(bodyParser.json());
<span class="linenos">34</span>app.use(bodyParser.urlencoded({
<span class="linenos">35</span>  extended: <span class="hljs-literal">true</span>
<span class="linenos">36</span>}));
<span class="linenos">37</span>
<span class="linenos">38</span><span class="hljs-comment">// Define index route</span>
<span class="linenos">39</span>app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> </span>{
<span class="linenos">40</span>  res.render(<span class="hljs-string">'index'</span>);
<span class="linenos">41</span>});
<span class="linenos">42</span>
<span class="linenos">43</span><span class="hljs-comment">// Serve static files</span>
<span class="linenos">44</span>app.use(express.static(__dirname + <span class="hljs-string">'/static'</span>));
<span class="linenos">45</span>
<span class="linenos">46</span><span class="hljs-comment">// Listen</span>
<span class="linenos">47</span>app.listen(port);
<span class="linenos">48</span><span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Listening on port '</span> + port);</code></pre><p>Let’s go through this code. First we confirm that linting tools should treat this as a Node app, and use strict mode (I recommend always using strict mode in JavaScript).</p><p>Then we declare our variables and import the required modules. Note here that we set the port to 5000, but can also set it based on the <code>PORT</code> environment variable, which is used by Heroku. We also define a base URL, which again can be overriden from an environment variable when hosted on Heroku.</p><p>We then set up our connection to our Redis instance. When we push the code up to Heroku, we’ll use the Redis To Go addon, so we check for an environment variable containing the Redis URL. If it’s set, we use that to connect. Otherwise, we just connect as normal.</p><p>We then set up templating using Jade, and define the folder containing our views, and store the base URL within the app. Then we set up <code>bodyParser</code> so that Express can handle POST data.</p><p>Next, we define our index route to just render the <code>index.jade</code> file. Finally, we set up our static folder and set the app to listen on the correct port.</p><p>Let’s run our test:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>Listening on port <span class="hljs-number">5000</span>
<span class="linenos">7</span>
<span class="linenos">8</span>
<span class="linenos">9</span>  server
<span class="linenos">10</span>Starting the server
<span class="linenos">11</span>    Test the index route
<span class="linenos">12</span>      ✓ should <span class="hljs-built_in">return</span> a page with the title Shortbread (<span class="hljs-number">116</span>ms)
<span class="linenos">13</span>Stopping the server
<span class="linenos">14</span>
<span class="linenos">15</span>
<span class="linenos">16</span>  <span class="hljs-number">1</span> passing (<span class="hljs-number">128</span>ms)
<span class="linenos">17</span>
<span class="linenos">18</span>=============================================================================
<span class="linenos">19</span>Writing coverage object [/Users/matthewdaly/Projects/url-shortener/coverage/coverage.json]
<span class="linenos">20</span>Writing coverage reports at [/Users/matthewdaly/Projects/url-shortener/coverage]
<span class="linenos">21</span>=============================================================================
<span class="linenos">22</span>
<span class="linenos">23</span>=============================== Coverage summary ===============================
<span class="linenos">24</span>Statements   : <span class="hljs-number">86.96</span>% ( <span class="hljs-number">20</span>/<span class="hljs-number">23</span> )
<span class="linenos">25</span>Branches     : <span class="hljs-number">83.33</span>% ( <span class="hljs-number">5</span>/<span class="hljs-number">6</span> )
<span class="linenos">26</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">1</span>/<span class="hljs-number">1</span> )
<span class="linenos">27</span>Lines        : <span class="hljs-number">86.96</span>% ( <span class="hljs-number">20</span>/<span class="hljs-number">23</span> )
<span class="linenos">28</span>================================================================================
<span class="linenos">29</span>&gt;&gt; Done. Check coverage folder.
<span class="linenos">30</span>
<span class="linenos">31</span>Done, without errors.</code></pre><p>Note that Istanbul will have generated a nice HTML coverage report, which will be at <code>coverage/index.html</code>, but this won’t show 100% test coverage due to the Heroku-specific Redis section. To fix this, amend that section as follows:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-comment">/* istanbul ignore if */</span>
<span class="linenos">2</span><span class="hljs-keyword">if</span> (process.env.REDISTOGO_URL) {
<span class="linenos">3</span>    rtg  = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>).parse(process.env.REDISTOGO_URL);
<span class="linenos">4</span>    client = <span class="hljs-built_in">require</span>(<span class="hljs-string">"redis"</span>).createClient(rtg.port, rtg.hostname);
<span class="linenos">5</span>    client.auth(rtg.auth.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">1</span>]);
<span class="linenos">6</span>} <span class="hljs-keyword">else</span> {
<span class="linenos">7</span>    client = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>).createClient();
<span class="linenos">8</span>}</code></pre><p>Telling Istanbul to ignore the if clause resolves that problem nicely.</p><h2 id="submitting-a-url">Submitting a URL</h2><p>Next, let’s add the ability to add a URL. First, add the following test, after the one for the index:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span>    <span class="hljs-comment">// Test submitting a URL</span>
<span class="linenos">2</span>    describe(<span class="hljs-string">'Test submitting a URL'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">3</span>        it(<span class="hljs-string">'should return the shortened URL'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">4</span>            request.post(<span class="hljs-string">'http://localhost:5000'</span>, {form: {url: <span class="hljs-string">'http://www.google.co.uk'</span>}}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, response, body)</span> </span>{
<span class="linenos">5</span>                expect(body).to.include(<span class="hljs-string">'Your shortened URL is'</span>);
<span class="linenos">6</span>                expect(response.statusCode).to.equal(<span class="hljs-number">200</span>);
<span class="linenos">7</span>                expect(response.headers[<span class="hljs-string">'content-type'</span>]).to.equal(<span class="hljs-string">'text/html; charset=utf-8'</span>);
<span class="linenos">8</span>                done();
<span class="linenos">9</span>            });
<span class="linenos">10</span>        });
<span class="linenos">11</span>    });</code></pre><p>This test submits a URL via POST, and checks to see that the response view gets returned. Now, let’s run our tests again:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>Listening on port <span class="hljs-number">5000</span>
<span class="linenos">7</span>
<span class="linenos">8</span>
<span class="linenos">9</span>  server
<span class="linenos">10</span>Starting the server
<span class="linenos">11</span>    Test the index route
<span class="linenos">12</span>      ✓ should <span class="hljs-built_in">return</span> a page with the title Shortbread (<span class="hljs-number">223</span>ms)
<span class="linenos">13</span>    Test submitting a URL
<span class="linenos">14</span>      <span class="hljs-number">1</span>) should <span class="hljs-built_in">return</span> the shortened URL
<span class="linenos">15</span>Stopping the server
<span class="linenos">16</span>
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="hljs-number">1</span> passing (<span class="hljs-number">318</span>ms)
<span class="linenos">19</span>  <span class="hljs-number">1</span> failing
<span class="linenos">20</span>
<span class="linenos">21</span>  <span class="hljs-number">1</span>) server Test submitting a URL should <span class="hljs-built_in">return</span> the shortened URL:
<span class="linenos">22</span>     Uncaught AssertionError: expected <span class="hljs-string">'Cannot POST /\n'</span> to include <span class="hljs-string">'Your shortened URL is'</span>
<span class="linenos">23</span>      at Request._callback (/Users/matthewdaly/Projects/url-shortener/<span class="hljs-built_in">test</span>/test.js:<span class="hljs-number">45</span>:<span class="hljs-number">33</span>)
<span class="linenos">24</span>      at Request.self.callback (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">372</span>:<span class="hljs-number">22</span>)
<span class="linenos">25</span>      at Request.emit (events.js:<span class="hljs-number">98</span>:<span class="hljs-number">17</span>)
<span class="linenos">26</span>      at Request.&lt;anonymous&gt; (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">1310</span>:<span class="hljs-number">14</span>)
<span class="linenos">27</span>      at Request.emit (events.js:<span class="hljs-number">117</span>:<span class="hljs-number">20</span>)
<span class="linenos">28</span>      at IncomingMessage.&lt;anonymous&gt; (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">1258</span>:<span class="hljs-number">12</span>)
<span class="linenos">29</span>      at IncomingMessage.emit (events.js:<span class="hljs-number">117</span>:<span class="hljs-number">20</span>)
<span class="linenos">30</span>      at _stream_readable.js:<span class="hljs-number">943</span>:<span class="hljs-number">16</span>
<span class="linenos">31</span>      at process._tickCallback (node.js:<span class="hljs-number">419</span>:<span class="hljs-number">13</span>)
<span class="linenos">32</span>
<span class="linenos">33</span>
<span class="linenos">34</span>
<span class="linenos">35</span>=============================================================================
<span class="linenos">36</span>Writing coverage object [/Users/matthewdaly/Projects/url-shortener/coverage/coverage.json]
<span class="linenos">37</span>Writing coverage reports at [/Users/matthewdaly/Projects/url-shortener/coverage]
<span class="linenos">38</span>=============================================================================
<span class="linenos">39</span>
<span class="linenos">40</span>=============================== Coverage summary ===============================
<span class="linenos">41</span>Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">23</span>/<span class="hljs-number">23</span> ), <span class="hljs-number">3</span> ignored
<span class="linenos">42</span>Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">6</span>/<span class="hljs-number">6</span> ), <span class="hljs-number">1</span> ignored
<span class="linenos">43</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">1</span>/<span class="hljs-number">1</span> )
<span class="linenos">44</span>Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">23</span>/<span class="hljs-number">23</span> )
<span class="linenos">45</span>================================================================================
<span class="linenos">46</span>&gt;&gt;
<span class="linenos">47</span>Warning: Task <span class="hljs-string">"mocha_istanbul:coverage"</span> failed. Use --force to continue.
<span class="linenos">48</span>
<span class="linenos">49</span>Aborted due to warnings.</code></pre><p>We have a failing test, so let’s make it pass. Add the following route after the index one:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-comment">// Define submit route</span>
<span class="linenos">2</span>app.post(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> </span>{
<span class="linenos">3</span>    <span class="hljs-comment">// Declare variables</span>
<span class="linenos">4</span>    <span class="hljs-keyword">var</span> url, id;
<span class="linenos">5</span>
<span class="linenos">6</span>    <span class="hljs-comment">// Get URL</span>
<span class="linenos">7</span>    url = req.body.url;
<span class="linenos">8</span>
<span class="linenos">9</span>    <span class="hljs-comment">// Create a hashed short version</span>
<span class="linenos">10</span>    id = shortid.generate();
<span class="linenos">11</span>
<span class="linenos">12</span>    <span class="hljs-comment">// Store them in Redis</span>
<span class="linenos">13</span>    client.set(id, url, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">14</span>        <span class="hljs-comment">// Display the response</span>
<span class="linenos">15</span>        res.render(<span class="hljs-string">'output'</span>, { id: id, base_url: base_url });
<span class="linenos">16</span>    });
<span class="linenos">17</span>});</code></pre><p>This route is fairly simple. It handles POST requests to the index route, and first of all it gets the URL from the POST request. Then it randomly generates a hash to use as the key.</p><p>The next part is where we see Redis in action. We create a new key-value pair, with the key set to the newly generated ID, and the value set to the URL. Once Redis confirms that has been done, the callback is fired, which renders the <code>output.jade</code> view with the ID and base URL passed through, so that we can see our shortened URL.</p><p>With that done, our test should pass:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>Listening on port <span class="hljs-number">5000</span>
<span class="linenos">7</span>
<span class="linenos">8</span>
<span class="linenos">9</span>  server
<span class="linenos">10</span>Starting the server
<span class="linenos">11</span>    Test the index route
<span class="linenos">12</span>      ✓ should <span class="hljs-built_in">return</span> a page with the title Shortbread (<span class="hljs-number">89</span>ms)
<span class="linenos">13</span>    Test submitting a URL
<span class="linenos">14</span>      ✓ should <span class="hljs-built_in">return</span> the shortened URL (<span class="hljs-number">65</span>ms)
<span class="linenos">15</span>Stopping the server
<span class="linenos">16</span>
<span class="linenos">17</span>
<span class="linenos">18</span>  <span class="hljs-number">2</span> passing (<span class="hljs-number">167</span>ms)
<span class="linenos">19</span>
<span class="linenos">20</span>=============================================================================
<span class="linenos">21</span>Writing coverage object [/Users/matthewdaly/Projects/url-shortener/coverage/coverage.json]
<span class="linenos">22</span>Writing coverage reports at [/Users/matthewdaly/Projects/url-shortener/coverage]
<span class="linenos">23</span>=============================================================================
<span class="linenos">24</span>
<span class="linenos">25</span>=============================== Coverage summary ===============================
<span class="linenos">26</span>Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">29</span>/<span class="hljs-number">29</span> ), <span class="hljs-number">3</span> ignored
<span class="linenos">27</span>Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">6</span>/<span class="hljs-number">6</span> ), <span class="hljs-number">1</span> ignored
<span class="linenos">28</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">3</span>/<span class="hljs-number">3</span> )
<span class="linenos">29</span>Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">29</span>/<span class="hljs-number">29</span> )
<span class="linenos">30</span>================================================================================
<span class="linenos">31</span>&gt;&gt; Done. Check coverage folder.
<span class="linenos">32</span>
<span class="linenos">33</span>Done, without errors.</code></pre><p>Our final task is to implement the short URL handling. We want to check to see if a short URL exists. If it does, we redirect the user to the destination. If it doesn’t, we raise a 404 error. For that we need two more tests. Here they are:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span>
<span class="linenos">2</span>    <span class="hljs-comment">// Test following a URL</span>
<span class="linenos">3</span>    describe(<span class="hljs-string">'Test following a URL'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">4</span>        it(<span class="hljs-string">'should redirect the user to the shortened URL'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">5</span>            <span class="hljs-comment">// Create the URL</span>
<span class="linenos">6</span>            client.set(<span class="hljs-string">'testurl'</span>, <span class="hljs-string">'http://www.google.com'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">7</span>                <span class="hljs-comment">// Follow the link</span>
<span class="linenos">8</span>                request.get({
<span class="linenos">9</span>                    url: <span class="hljs-string">'http://localhost:5000/testurl'</span>,
<span class="linenos">10</span>                    followRedirect: <span class="hljs-literal">false</span>
<span class="linenos">11</span>                }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, response, body)</span> </span>{
<span class="linenos">12</span>                    expect(response.headers.location).to.equal(<span class="hljs-string">'http://www.google.com'</span>);
<span class="linenos">13</span>                    expect(response.statusCode).to.equal(<span class="hljs-number">301</span>);
<span class="linenos">14</span>                    done();
<span class="linenos">15</span>                });
<span class="linenos">16</span>            });
<span class="linenos">17</span>        });
<span class="linenos">18</span>    });
<span class="linenos">19</span>
<span class="linenos">20</span>    <span class="hljs-comment">// Test non-existent link</span>
<span class="linenos">21</span>    describe(<span class="hljs-string">'Test following a non-existent-link'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="linenos">22</span>        it(<span class="hljs-string">'should return a 404 error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(done)</span> </span>{
<span class="linenos">23</span>            <span class="hljs-comment">// Follow the link</span>
<span class="linenos">24</span>            request.get({
<span class="linenos">25</span>                url: <span class="hljs-string">'http://localhost:5000/nonexistenturl'</span>,
<span class="linenos">26</span>                followRedirect: <span class="hljs-literal">false</span>
<span class="linenos">27</span>            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, response, body)</span> </span>{
<span class="linenos">28</span>                expect(response.statusCode).to.equal(<span class="hljs-number">404</span>);
<span class="linenos">29</span>                expect(body).to.include(<span class="hljs-string">'Link not found'</span>);
<span class="linenos">30</span>                done();
<span class="linenos">31</span>            });
<span class="linenos">32</span>        });
<span class="linenos">33</span>    });</code></pre><p>The first test creates a URL for testing purposes. It then navigates to that URL. Note that we set <code>followRedirect</code> to <code>true</code> - this is because, by default, <code>request</code> will follow any redirect, so we need to prevent it from doing so to ensure that the headers to redirect the user are set correctly.</p><p>Once the response has been received, we then check that the status code is 301 (Moved Permanently), and that the <code>Location</code> header is set to the correct destination. When a real browser visits this page, it will be redirected accordingly.</p><p>The second test tries to fetch a non-existent URL, and checks that the status code is 404, and the response contains the words <code>Link not found</code>.</p><p>If we run our tests, they should now fail:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>Listening on port <span class="hljs-number">5000</span>
<span class="linenos">7</span>
<span class="linenos">8</span>
<span class="linenos">9</span>  server
<span class="linenos">10</span>Starting the server
<span class="linenos">11</span>    Test the index route
<span class="linenos">12</span>      ✓ should <span class="hljs-built_in">return</span> a page with the title Shortbread (<span class="hljs-number">252</span>ms)
<span class="linenos">13</span>    Test submitting a URL
<span class="linenos">14</span>      ✓ should <span class="hljs-built_in">return</span> the shortened URL (<span class="hljs-number">47</span>ms)
<span class="linenos">15</span>    Test following a URL
<span class="linenos">16</span>      <span class="hljs-number">1</span>) should redirect the user to the shortened URL
<span class="linenos">17</span>    Test following a non-existent-link
<span class="linenos">18</span>      <span class="hljs-number">2</span>) should <span class="hljs-built_in">return</span> a <span class="hljs-number">404</span> error
<span class="linenos">19</span>Stopping the server
<span class="linenos">20</span>
<span class="linenos">21</span>
<span class="linenos">22</span>  <span class="hljs-number">2</span> passing (<span class="hljs-number">322</span>ms)
<span class="linenos">23</span>  <span class="hljs-number">2</span> failing
<span class="linenos">24</span>
<span class="linenos">25</span>  <span class="hljs-number">1</span>) server Test following a URL should redirect the user to the shortened URL:
<span class="linenos">26</span>     Uncaught AssertionError: expected undefined to equal <span class="hljs-string">'http://www.google.com'</span>
<span class="linenos">27</span>      at Request._callback (/Users/matthewdaly/Projects/url-shortener/<span class="hljs-built_in">test</span>/test.js:<span class="hljs-number">63</span>:<span class="hljs-number">58</span>)
<span class="linenos">28</span>      at Request.self.callback (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">372</span>:<span class="hljs-number">22</span>)
<span class="linenos">29</span>      at Request.emit (events.js:<span class="hljs-number">98</span>:<span class="hljs-number">17</span>)
<span class="linenos">30</span>      at Request.&lt;anonymous&gt; (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">1310</span>:<span class="hljs-number">14</span>)
<span class="linenos">31</span>      at Request.emit (events.js:<span class="hljs-number">117</span>:<span class="hljs-number">20</span>)
<span class="linenos">32</span>      at IncomingMessage.&lt;anonymous&gt; (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">1258</span>:<span class="hljs-number">12</span>)
<span class="linenos">33</span>      at IncomingMessage.emit (events.js:<span class="hljs-number">117</span>:<span class="hljs-number">20</span>)
<span class="linenos">34</span>      at _stream_readable.js:<span class="hljs-number">943</span>:<span class="hljs-number">16</span>
<span class="linenos">35</span>      at process._tickCallback (node.js:<span class="hljs-number">419</span>:<span class="hljs-number">13</span>)
<span class="linenos">36</span>
<span class="linenos">37</span>  <span class="hljs-number">2</span>) server Test following a non-existent-link should <span class="hljs-built_in">return</span> a <span class="hljs-number">404</span> error:
<span class="linenos">38</span>     Uncaught AssertionError: expected <span class="hljs-string">'Cannot GET /nonexistenturl\n'</span> to include <span class="hljs-string">'Link not found'</span>
<span class="linenos">39</span>      at Request._callback (/Users/matthewdaly/Projects/url-shortener/<span class="hljs-built_in">test</span>/test.js:<span class="hljs-number">80</span>:<span class="hljs-number">33</span>)
<span class="linenos">40</span>      at Request.self.callback (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">372</span>:<span class="hljs-number">22</span>)
<span class="linenos">41</span>      at Request.emit (events.js:<span class="hljs-number">98</span>:<span class="hljs-number">17</span>)
<span class="linenos">42</span>      at Request.&lt;anonymous&gt; (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">1310</span>:<span class="hljs-number">14</span>)
<span class="linenos">43</span>      at Request.emit (events.js:<span class="hljs-number">117</span>:<span class="hljs-number">20</span>)
<span class="linenos">44</span>      at IncomingMessage.&lt;anonymous&gt; (/Users/matthewdaly/Projects/url-shortener/node_modules/request/request.js:<span class="hljs-number">1258</span>:<span class="hljs-number">12</span>)
<span class="linenos">45</span>      at IncomingMessage.emit (events.js:<span class="hljs-number">117</span>:<span class="hljs-number">20</span>)
<span class="linenos">46</span>      at _stream_readable.js:<span class="hljs-number">943</span>:<span class="hljs-number">16</span>
<span class="linenos">47</span>      at process._tickCallback (node.js:<span class="hljs-number">419</span>:<span class="hljs-number">13</span>)
<span class="linenos">48</span>
<span class="linenos">49</span>
<span class="linenos">50</span>
<span class="linenos">51</span>=============================================================================
<span class="linenos">52</span>Writing coverage object [/Users/matthewdaly/Projects/url-shortener/coverage/coverage.json]
<span class="linenos">53</span>Writing coverage reports at [/Users/matthewdaly/Projects/url-shortener/coverage]
<span class="linenos">54</span>=============================================================================
<span class="linenos">55</span>
<span class="linenos">56</span>=============================== Coverage summary ===============================
<span class="linenos">57</span>Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">29</span>/<span class="hljs-number">29</span> ), <span class="hljs-number">3</span> ignored
<span class="linenos">58</span>Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">6</span>/<span class="hljs-number">6</span> ), <span class="hljs-number">1</span> ignored
<span class="linenos">59</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">3</span>/<span class="hljs-number">3</span> )
<span class="linenos">60</span>Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">29</span>/<span class="hljs-number">29</span> )
<span class="linenos">61</span>================================================================================
<span class="linenos">62</span>&gt;&gt;
<span class="linenos">63</span>Warning: Task <span class="hljs-string">"mocha_istanbul:coverage"</span> failed. Use --force to continue.
<span class="linenos">64</span>
<span class="linenos">65</span>Aborted due to warnings.</code></pre><p>Now, let’s add our final route:</p><pre><code class="hljs lang-javascript"><span class="linenos">1</span><span class="hljs-comment">// Define link route</span>
<span class="linenos">2</span>app.route(<span class="hljs-string">'/:id'</span>).all(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> </span>{
<span class="linenos">3</span>    <span class="hljs-comment">// Get ID</span>
<span class="linenos">4</span>    <span class="hljs-keyword">var</span> id = req.params.id.trim();
<span class="linenos">5</span>
<span class="linenos">6</span>    <span class="hljs-comment">// Look up the URL</span>
<span class="linenos">7</span>    client.get(id, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, reply)</span> </span>{
<span class="linenos">8</span>        <span class="hljs-keyword">if</span> (!err &amp;&amp; reply) {
<span class="linenos">9</span>            <span class="hljs-comment">// Redirect user to it</span>
<span class="linenos">10</span>            res.status(<span class="hljs-number">301</span>);
<span class="linenos">11</span>            res.set(<span class="hljs-string">'Location'</span>, reply);
<span class="linenos">12</span>            res.send();
<span class="linenos">13</span>        } <span class="hljs-keyword">else</span> {
<span class="linenos">14</span>            <span class="hljs-comment">// Confirm no such link in database</span>
<span class="linenos">15</span>            res.status(<span class="hljs-number">404</span>);
<span class="linenos">16</span>            res.render(<span class="hljs-string">'error'</span>);
<span class="linenos">17</span>        }
<span class="linenos">18</span>    });
<span class="linenos">19</span>});</code></pre><p>We accept the ID as a parameter in the URL. We trim off any whitespace around it, and then we query Redis for a URL with that ID. If we find one, we set the status code to 301, and the location to the URL, and send the response. Otherwise, we set the status to 404 and render the error view.</p><p>Now, let’s check it passes:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ grunt <span class="hljs-built_in">test</span>
<span class="linenos">2</span>Running <span class="hljs-string">"jshint:all"</span> (jshint) task
<span class="linenos">3</span>&gt;&gt; <span class="hljs-number">2</span> files lint free.
<span class="linenos">4</span>
<span class="linenos">5</span>Running <span class="hljs-string">"mocha_istanbul:coverage"</span> (mocha_istanbul) task
<span class="linenos">6</span>Listening on port <span class="hljs-number">5000</span>
<span class="linenos">7</span>
<span class="linenos">8</span>
<span class="linenos">9</span>  server
<span class="linenos">10</span>Starting the server
<span class="linenos">11</span>    Test the index route
<span class="linenos">12</span>      ✓ should <span class="hljs-built_in">return</span> a page with the title Shortbread (<span class="hljs-number">90</span>ms)
<span class="linenos">13</span>    Test submitting a URL
<span class="linenos">14</span>      ✓ should <span class="hljs-built_in">return</span> the shortened URL (<span class="hljs-number">47</span>ms)
<span class="linenos">15</span>    Test following a URL
<span class="linenos">16</span>      ✓ should redirect the user to the shortened URL
<span class="linenos">17</span>    Test following a non-existent-link
<span class="linenos">18</span>      ✓ should <span class="hljs-built_in">return</span> a <span class="hljs-number">404</span> error
<span class="linenos">19</span>Stopping the server
<span class="linenos">20</span>
<span class="linenos">21</span>
<span class="linenos">22</span>  <span class="hljs-number">4</span> passing (<span class="hljs-number">191</span>ms)
<span class="linenos">23</span>
<span class="linenos">24</span>=============================================================================
<span class="linenos">25</span>Writing coverage object [/Users/matthewdaly/Projects/url-shortener/coverage/coverage.json]
<span class="linenos">26</span>Writing coverage reports at [/Users/matthewdaly/Projects/url-shortener/coverage]
<span class="linenos">27</span>=============================================================================
<span class="linenos">28</span>
<span class="linenos">29</span>=============================== Coverage summary ===============================
<span class="linenos">30</span>Statements   : <span class="hljs-number">100</span>% ( <span class="hljs-number">38</span>/<span class="hljs-number">38</span> ), <span class="hljs-number">3</span> ignored
<span class="linenos">31</span>Branches     : <span class="hljs-number">100</span>% ( <span class="hljs-number">10</span>/<span class="hljs-number">10</span> ), <span class="hljs-number">1</span> ignored
<span class="linenos">32</span>Functions    : <span class="hljs-number">100</span>% ( <span class="hljs-number">5</span>/<span class="hljs-number">5</span> )
<span class="linenos">33</span>Lines        : <span class="hljs-number">100</span>% ( <span class="hljs-number">38</span>/<span class="hljs-number">38</span> )
<span class="linenos">34</span>================================================================================
<span class="linenos">35</span>&gt;&gt; Done. Check coverage folder.
<span class="linenos">36</span>
<span class="linenos">37</span>Done, without errors.</code></pre><p>Excellent! Our URL shortener is now complete. From here, deploying it to Heroku is straightforward - you’ll need to install the Redis to Go addon, and refer to Heroku’s documentation on deploying Node.js applications for more details.</p><h2 id="wrapping-up">Wrapping up</h2><p>You’ll find the source for this application at <a href="https://github.com/matthewbdaly/Shortbread">https://github.com/matthewbdaly/Shortbread</a> and a demo at <a href="http://shortbread-example.herokuapp.com/">http://shortbread-example.herokuapp.com/</a>.</p><p>I hope you’ve enjoyed this brief introduction to Redis, and that it’s opened your eyes to at least one of the alternatives out there to a relational database. I’ll hopefully be able to follow this up with examples of some other problems Redis is ideal for solving.</p></article><article class="post"><p class="date">19th October 2014 7:52 pm</p><h1><a href="/blog/2014/10/19/my-django-web-server-setup/">My Django Web Server Setup</a></h1><p>This isn’t really part of my Django tutorial series (that has now definitely concluded!), but I thought I’d share the setup I generally use for deploying Django applications, partly for my own reference, and partly because it is quite complex, and those readers who don’t wish to deploy to Heroku may want some guidance on how to deploy their new blogs to a VPS.</p><h2 id="operating-system">Operating system</h2><p>This isn’t actually that much of a big deal, but while I prefer Ubuntu on desktops, I generally use Debian Stable on servers, since it’s fanatically stable.</p><h2 id="database-server">Database server</h2><p>For my first commercial Django app, I used MySQL. However, South had one or two issues with MySQL, and I figured that since using an ORM and migrations meant that I wouldn’t need to write much SQL anyway, I might as well jump to PostgreSQL for the Django app I’m currently in the process of deploying at work. So far I haven’t had any problems with it.</p><h2 id="web-server">Web server</h2><p>It’s customary to use two web servers with Django. One handles the static content, and reverse proxies everything else to a different port, where another web server serves the dynamic content.</p><p>For serving the static files, I use Nginx - it’s generally considered to be faster than Apache for this use case. Here’s a typical Nginx config file:</p><pre><code class="hljs lang-nginx"><span class="linenos">1</span><span class="hljs-title">server</span> {
<span class="linenos">2</span>    <span class="hljs-title">listen</span> <span class="hljs-number">80</span>;
<span class="linenos">3</span>    <span class="hljs-title">server_name</span> example.com;
<span class="linenos">4</span>    <span class="hljs-title">client_max_body_size</span> <span class="hljs-number">50M</span>;
<span class="linenos">5</span>
<span class="linenos">6</span>    <span class="hljs-title">access_log</span> /var/log/nginx/access.log;
<span class="linenos">7</span>    <span class="hljs-title">error_log</span> /var/log/nginx/error.log;
<span class="linenos">8</span>
<span class="linenos">9</span>    <span class="hljs-title">location</span> /static {
<span class="linenos">10</span>        <span class="hljs-title">root</span> /var/www/mysite;
<span class="linenos">11</span>    }
<span class="linenos">12</span>
<span class="linenos">13</span>    <span class="hljs-title">location</span> /media {
<span class="linenos">14</span>        <span class="hljs-title">root</span> /var/www/mysite;
<span class="linenos">15</span>    }
<span class="linenos">16</span>
<span class="linenos">17</span>    <span class="hljs-title">location</span> / {
<span class="linenos">18</span>        <span class="hljs-title">proxy_pass</span> <span class="hljs-url">http://127.0.0.1:8000</span>;
<span class="linenos">19</span>    }
<span class="linenos">20</span>}</code></pre><p>For the application server, I use Gunicorn. You can install this with <code>pip install gunicorn</code>, then add it to <code>INSTALLED_APPS</code>. Then add the following config file to the root of your project, as <code>gunicorn.conf.py</code>:</p><pre><code class="hljs lang-python"><span class="linenos">1</span>bind = <span class="hljs-string">"127.0.0.1:8000"</span>
<span class="linenos">2</span>logfile = <span class="hljs-string">"/var/log/gunicorn.log"</span>
<span class="linenos">3</span>loglevel = <span class="hljs-string">"debug"</span>
<span class="linenos">4</span>workers = <span class="hljs-number">3</span></code></pre><p>You should normally set the number of workers to 2 times the number of cores on your machine, plus one.</p><p>In order to keep Gunicorn running, I use Supervisor. As the installation commands will depend on your OS, I won’t give details here - your package manager of choice should have a suitable package available. Here’s a typical Supervisor config file I might use for running Gunicorn for a Django app, named <code>mysite-supervisor.conf</code>:</p><pre><code class="hljs lang-ini"><span class="linenos">1</span><span class="hljs-title">[program:mysite]</span>
<span class="linenos">2</span><span class="hljs-setting">command=<span class="hljs-value">/var/www/mysite/venv/bin/gunicorn myapp.wsgi:application --workers=<span class="hljs-number">3</span></span></span>
<span class="linenos">3</span><span class="hljs-setting">directory=<span class="hljs-value">/var/www/mysite/</span></span>
<span class="linenos">4</span><span class="hljs-setting">user=<span class="hljs-value">nobody</span></span>
<span class="linenos">5</span><span class="hljs-setting">autostart=<span class="hljs-value"><span class="hljs-keyword">true</span></span></span>
<span class="linenos">6</span><span class="hljs-setting">autorestart=<span class="hljs-value"><span class="hljs-keyword">true</span></span></span></code></pre><p>Once that’s in place, you can easily add the new app:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ sudo supervisorctl reread
<span class="linenos">2</span>$ sudo supervisorctl update</code></pre><p>Then to start it:</p><pre><code class="hljs lang-bash singleline">$ sudo supervisorctl start mysite</code></pre><p>Or stop it with:</p><pre><code class="hljs lang-bash singleline">$ sudo supervisorctl stop mysite</code></pre><p>Or restart it:</p><pre><code class="hljs lang-bash singleline">$ sudo supervisorctl restart mysite</code></pre><h2 id="celery">Celery</h2><p>So far, both of the web apps I’ve built professionally have been ones where it made sense to use <a href="http://www.celeryproject.org/">Celery</a> for some tasks. For the uninitiated, Celery lets you pass a task to a queue to be handled, rather than handling it within the context of the same HTTP request. This offers the following advantages:</p><ul><li>The user doesn’t need to wait for the task to be completed before getting a response, improving performance</li><li>It’s more robust, since if the task fails, it can be automatically retried</li><li>The task queue can be moved to another server if desired, making it easier to scale</li><li>Scheduling tasks</li></ul><p>I’ve used it in cases where I needed to send an email or a push notification, since these don’t have to be done within the context of the same HTTP request, but need to be reliable.</p><p>I generally use RabbitMQ as my message queue. I’ll leave setting this up as an exercise for the reader since it’s covered pretty well in the Celery documentation, but like with Gunicorn, I use Supervisor to run the Celery worker. Here’s a typical config file, which might be called <code>celery-supervisor.conf</code>:</p><pre><code class="hljs lang-ini"><span class="linenos">1</span><span class="hljs-title">[program:celeryd]</span>
<span class="linenos">2</span><span class="hljs-setting">command=<span class="hljs-value">/var/www/mysite/venv/bin/python manage.py celery worker</span></span>
<span class="linenos">3</span><span class="hljs-setting">directory=<span class="hljs-value">/var/www/mysite/</span></span>
<span class="linenos">4</span><span class="hljs-setting">user=<span class="hljs-value">nobody</span></span>
<span class="linenos">5</span><span class="hljs-setting">autostart=<span class="hljs-value"><span class="hljs-keyword">true</span></span></span>
<span class="linenos">6</span><span class="hljs-setting">autorestart=<span class="hljs-value"><span class="hljs-keyword">true</span></span></span></code></pre><p>Then start it up:</p><pre><code class="hljs lang-bash"><span class="linenos">1</span>$ sudo supervisorctl reread
<span class="linenos">2</span>$ sudo supervisorctl update
<span class="linenos">3</span>$ sudo supervisorctl start celeryd</code></pre><p>I make no claims about how good this setup is, but it works well for me. I haven’t yet had the occasion to deploy a Django app to anywhere other than Heroku that really benefited from caching, so I haven’t got any tips to share about that, but if I were building a content-driven web app, I would use Memcached since it’s well-supported.</p></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2015/05/03/my-static-site-generator-post-on-sitepoint/">My Static Site Generator Post on Sitepoint</a></p><p><a href="/blog/2015/04/18/how-i-added-search-to-my-site-with-lunr-dot-js/">How I Added Search to My Site With Lunr.js</a></p><p><a href="/blog/2015/04/04/adding-a-new-search-engine-to-my-site/">Adding a New Search Engine to My Site</a></p><p><a href="/blog/2015/03/02/syntax-highlighting-in-fenced-code-blocks-in-vim/">Syntax Highlighting in Fenced Code Blocks in Vim</a></p><p><a href="/blog/2015/03/02/extending-our-node-dot-js-and-redis-chat-server/">Extending Our Node.js and Redis Chat Server</a></p><section id="github-profile"></section><h4>My GitHub repositories</h4><ul id="github-repos"><li>Loading repositories...</li></ul></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/posts/1/">Newer</a></li><li><a href="/posts/3/">Older</a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2015.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script></body></html>